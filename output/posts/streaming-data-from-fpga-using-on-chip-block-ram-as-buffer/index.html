<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Streaming data from FPGA: Using on-chip block RAM as buffer. | Alex Savochkin</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://alexandersavochkin.github.io/posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Alex Savochkin">
<link rel="prev" href="../fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/" title="FPGA-Driven data streaming into Raspberry Pi through GPIO: Speed and timing stability." type="text/html">
<meta property="og:site_name" content="Alex Savochkin">
<meta property="og:title" content="Streaming data from FPGA: Using on-chip block RAM as buffer.">
<meta property="og:url" content="https://alexandersavochkin.github.io/posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/">
<meta property="og:description" content="Introduction
This post continues the series of posts describing experiments with using FPGA as a high speed (millions of samples per second)
data capturing device and continues my previous post, where">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-03-24T22:17:28-07:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Alex Savochkin</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="index.rst" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../pages/about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Streaming data from FPGA: Using on-chip block RAM as buffer.</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Alex Savochkin
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2024-03-24T22:17:28-07:00" itemprop="datePublished" title="2024-03-24 22:17">2024-03-24 22:17</time></a>
            </p>
                <p class="commentline">
    


            
        </p>
<p class="sourceline"><a href="index.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <section id="introduction"><h2>Introduction</h2>
<p>This post continues the series of posts describing experiments with using FPGA as a high speed (millions of samples per second)
data capturing device and continues my previous post, where we defined the exchange protocol and measured timing. As I
concluded in that post, we need to have a buffer on the capturing device side which can hold the samples is the computer
reading the data temporary stops polling the data due to handling OS interrupts.</p>
<p>Conveniently, FPGAs typically have RAM on the chip which can be used for builing such a buffer, and we will explore how
to use it in this post. We will create a simple data generator which will simulate the data and write it into the buffer,
and then read the data from the buffer and transfer it into the parallel bus.</p>
<p>This test program partially implements my project of building a microphone array with multiple INMP441 microphones
connected to the FPGA, which I briefly describe in the next section.</p>
</section><section id="high-level-design-overview"><h2>High level design overview</h2>
<p>Here is the diagram of the digital device I am having in mind</p>
<img alt="/images/microphone-array-simulation.png" src="../../images/microphone-array-simulation.png" style="width: 1034.0px; height: 785.0px;"><p>According to out estimation we need buffer of size &gt; 260 samples, we will implement 512 samples buffer which
will have and extra space which helps to cover cases when two interrupts comming almost simultaneously.</p>
<p>The iCE40HX1K chip has 16 blocks of RAM 4096 bits (512 bytes) each.
Each block can be configured for storing 256 x 16-bit, 512 x 8-bit bytes, 1024 x 4-bit or 2048 x 2-bit memory cell.
Since I am aiming to capture 24-bit samples from multiple INMP441 microphones, my samples are 24-bit wide, so in
order to utilize the memory efficiently I decided to use 3 blocks configured as 512x8:  1st block will keep bits
0..7, 2nd block will keep bits 8..15 and 3rd block will keep bits 16..23.</p>
<p>We will design the multiple I2S capturing part in the next posts, today we will replace it with a simulated data
which will be written into the circular buffer and focus on data reading and transferring into the parallel bus.</p>
<p>The exchange protocol is the same is in the time measurment setup described in the previous post: the "device"
(FPGA) waits for the rising edge of the "Data Req" (data request) line and sets its 21-bit data output, but this
time it reads it from the memory instead of using timer value. Then the "device" sets the "Data Rdy" (data ready)
line to HIGH. The polling program detects the change in the "Data Rdy"  line, reads and records the 21-bit data value from
the parallel bus, and then sets "Data Req" to low on the SBC. This signals to the device that the SBC has successfully
read the data, prompting it to set "Data Rdy" to low. The polling program detects the falling edge of the "Data Rdy"
line and proceeds to the next cycle iteration.</p>
<p>Previously we used the timer value as the data, it is pretty much the same in this design, but the timer value is written
the FIFO buffer and the reading part of the system gets in from the reading side of the FIFO and sends to thr parallel bus.</p>
<p>The timer is 8-bit wide now, we repeat it 3 times to get 24-bit value, so the data should be least significant 21 bytes
of the 24-bit value &lt;Timer[7:0], Timer[7:0], Timer[7:0]&gt;. As a quick reminder we are using 21-bit data value because
we run out of pins on iCEstick board.</p>
</section><section id="verilog-implementation"><h2>Verilog implementation</h2>
<p>I think there are modules similar to PLL (see the previous post) which can be used for defining the RAM block in Verilog.
<a class="reference external" href="https://www.latticesemi.com/-/media/LatticeSemi/Documents/ApplicationNotes/MO/MemoryUsageGuideforiCE40Devices.ashx?document_id=47775">The Memory Usage Guide for iCE40 Devices</a>
mentions the <cite>SB_RAM512x8</cite>, <cite>SB_RAM1024x4</cite> modules, but I think they are Lattice/iCE40-specific and I am not sure how to use them with apio.</p>
<p>There is also another, more portable way to infer RAM blocks in Verilog, which is supported by most of the FPGA synthesis tools.
We will follow this way in our design. The following code snippet shows how to define a 512x8 memory block in Verilog
which can be inferred as a Block RAM by the synthesis tool.</p>
<div class="code"><pre class="code verilog"><a id="rest_code_6081c69e5daa4e4fbfaf796627186778-1" name="rest_code_6081c69e5daa4e4fbfaf796627186778-1" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-1"></a><span class="k">module</span><span class="w"> </span><span class="n">ram512x8</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-2" name="rest_code_6081c69e5daa4e4fbfaf796627186778-2" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-2"></a><span class="p">(</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-3" name="rest_code_6081c69e5daa4e4fbfaf796627186778-3" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RADDR</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-4" name="rest_code_6081c69e5daa4e4fbfaf796627186778-4" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RCLK</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-5" name="rest_code_6081c69e5daa4e4fbfaf796627186778-5" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RE</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-6" name="rest_code_6081c69e5daa4e4fbfaf796627186778-6" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RDATA</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-7" name="rest_code_6081c69e5daa4e4fbfaf796627186778-7" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WDATA</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-8" name="rest_code_6081c69e5daa4e4fbfaf796627186778-8" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-8"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WADDR</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-9" name="rest_code_6081c69e5daa4e4fbfaf796627186778-9" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-9"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WCLK</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-10" name="rest_code_6081c69e5daa4e4fbfaf796627186778-10" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WE</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-11" name="rest_code_6081c69e5daa4e4fbfaf796627186778-11" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-11"></a><span class="p">);</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-12" name="rest_code_6081c69e5daa4e4fbfaf796627186778-12" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-12"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">511</span><span class="p">];</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-13" name="rest_code_6081c69e5daa4e4fbfaf796627186778-13" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-13"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-14" name="rest_code_6081c69e5daa4e4fbfaf796627186778-14" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-14"></a><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-15" name="rest_code_6081c69e5daa4e4fbfaf796627186778-15" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-15"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-16" name="rest_code_6081c69e5daa4e4fbfaf796627186778-16" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-16"></a><span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-17" name="rest_code_6081c69e5daa4e4fbfaf796627186778-17" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-17"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">512</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="c1">// start with blank memory with 0 instead of x so that we can infer Yosys for BRAM.</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-18" name="rest_code_6081c69e5daa4e4fbfaf796627186778-18" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-18"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">'d0</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-19" name="rest_code_6081c69e5daa4e4fbfaf796627186778-19" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-19"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-20" name="rest_code_6081c69e5daa4e4fbfaf796627186778-20" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-20"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-21" name="rest_code_6081c69e5daa4e4fbfaf796627186778-21" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-21"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">RCLK</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-22" name="rest_code_6081c69e5daa4e4fbfaf796627186778-22" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-22"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-23" name="rest_code_6081c69e5daa4e4fbfaf796627186778-23" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RE</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-24" name="rest_code_6081c69e5daa4e4fbfaf796627186778-24" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-24"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-25" name="rest_code_6081c69e5daa4e4fbfaf796627186778-25" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-25"></a><span class="w">            </span><span class="n">RDATA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">RADDR</span><span class="p">];</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-26" name="rest_code_6081c69e5daa4e4fbfaf796627186778-26" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-26"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-27" name="rest_code_6081c69e5daa4e4fbfaf796627186778-27" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-27"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-28" name="rest_code_6081c69e5daa4e4fbfaf796627186778-28" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-28"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-29" name="rest_code_6081c69e5daa4e4fbfaf796627186778-29" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-29"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">WCLK</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-30" name="rest_code_6081c69e5daa4e4fbfaf796627186778-30" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-30"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-31" name="rest_code_6081c69e5daa4e4fbfaf796627186778-31" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WE</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-32" name="rest_code_6081c69e5daa4e4fbfaf796627186778-32" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-32"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-33" name="rest_code_6081c69e5daa4e4fbfaf796627186778-33" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-33"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">WADDR</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WDATA</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-34" name="rest_code_6081c69e5daa4e4fbfaf796627186778-34" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-34"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-35" name="rest_code_6081c69e5daa4e4fbfaf796627186778-35" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-35"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-36" name="rest_code_6081c69e5daa4e4fbfaf796627186778-36" href="#rest_code_6081c69e5daa4e4fbfaf796627186778-36"></a><span class="k">endmodule</span>
</pre></div>
<p>When the synthesis tool sees an array of registers with a specific read and write access pattern, which matches the
RAM block (like one above), it will infer the RAM block instead of using the LUTs.</p>
<p>Here is how we define the buffer in our top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1"></a><span class="c1">//Define memory access signals</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3"></a><span class="kt">wire</span><span class="w"> </span><span class="n">r_en</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_data</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7"></a><span class="kt">reg</span><span class="w"> </span><span class="n">w_en</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10"></a><span class="c1">//We will use 3 blocks of 512x8 RAM to store 24-bit samples</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11"></a><span class="c1">//Each the blocks share read address (r_addr), write address (w_addr),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12"></a><span class="c1">//write enable (w_en) and read enable (r_en) signals. We write the same</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13"></a><span class="c1">//value to all 3 blocks, (since it is simulated data), and read the data into</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14"></a><span class="c1">//different bits of the memory_read_value signal.</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_0</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27"></a><span class="p">);</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_1</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40"></a><span class="p">);</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_2</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53" href="#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53"></a><span class="p">);</span>
</pre></div>
<p>The simulation part is pretty simple, we generate the data and write it into each buffer:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_6e1781c3b8a541829ed2243706f57574-1" name="rest_code_6e1781c3b8a541829ed2243706f57574-1" href="#rest_code_6e1781c3b8a541829ed2243706f57574-1"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w">  </span><span class="c1">//Controls stage of writing data into the buffer</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-2" name="rest_code_6e1781c3b8a541829ed2243706f57574-2" href="#rest_code_6e1781c3b8a541829ed2243706f57574-2"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter2</span><span class="p">;</span><span class="w"> </span><span class="c1">//Counter representing the simulated data</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-3" name="rest_code_6e1781c3b8a541829ed2243706f57574-3" href="#rest_code_6e1781c3b8a541829ed2243706f57574-3"></a>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-4" name="rest_code_6e1781c3b8a541829ed2243706f57574-4" href="#rest_code_6e1781c3b8a541829ed2243706f57574-4"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">ref_clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-5" name="rest_code_6e1781c3b8a541829ed2243706f57574-5" href="#rest_code_6e1781c3b8a541829ed2243706f57574-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-6" name="rest_code_6e1781c3b8a541829ed2243706f57574-6" href="#rest_code_6e1781c3b8a541829ed2243706f57574-6"></a><span class="w">        </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-7" name="rest_code_6e1781c3b8a541829ed2243706f57574-7" href="#rest_code_6e1781c3b8a541829ed2243706f57574-7"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-8" name="rest_code_6e1781c3b8a541829ed2243706f57574-8" href="#rest_code_6e1781c3b8a541829ed2243706f57574-8"></a><span class="w">        </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-9" name="rest_code_6e1781c3b8a541829ed2243706f57574-9" href="#rest_code_6e1781c3b8a541829ed2243706f57574-9"></a><span class="w">        </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-10" name="rest_code_6e1781c3b8a541829ed2243706f57574-10" href="#rest_code_6e1781c3b8a541829ed2243706f57574-10"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-11" name="rest_code_6e1781c3b8a541829ed2243706f57574-11" href="#rest_code_6e1781c3b8a541829ed2243706f57574-11"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-12" name="rest_code_6e1781c3b8a541829ed2243706f57574-12" href="#rest_code_6e1781c3b8a541829ed2243706f57574-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-13" name="rest_code_6e1781c3b8a541829ed2243706f57574-13" href="#rest_code_6e1781c3b8a541829ed2243706f57574-13"></a><span class="w">            </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-14" name="rest_code_6e1781c3b8a541829ed2243706f57574-14" href="#rest_code_6e1781c3b8a541829ed2243706f57574-14"></a><span class="w">            </span><span class="n">w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">~</span><span class="n">counter2</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-15" name="rest_code_6e1781c3b8a541829ed2243706f57574-15" href="#rest_code_6e1781c3b8a541829ed2243706f57574-15"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-16" name="rest_code_6e1781c3b8a541829ed2243706f57574-16" href="#rest_code_6e1781c3b8a541829ed2243706f57574-16"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-17" name="rest_code_6e1781c3b8a541829ed2243706f57574-17" href="#rest_code_6e1781c3b8a541829ed2243706f57574-17"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">5</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-18" name="rest_code_6e1781c3b8a541829ed2243706f57574-18" href="#rest_code_6e1781c3b8a541829ed2243706f57574-18"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-19" name="rest_code_6e1781c3b8a541829ed2243706f57574-19" href="#rest_code_6e1781c3b8a541829ed2243706f57574-19"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">6</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-20" name="rest_code_6e1781c3b8a541829ed2243706f57574-20" href="#rest_code_6e1781c3b8a541829ed2243706f57574-20"></a><span class="w">            </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-21" name="rest_code_6e1781c3b8a541829ed2243706f57574-21" href="#rest_code_6e1781c3b8a541829ed2243706f57574-21"></a><span class="w">            </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">w_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-22" name="rest_code_6e1781c3b8a541829ed2243706f57574-22" href="#rest_code_6e1781c3b8a541829ed2243706f57574-22"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-23" name="rest_code_6e1781c3b8a541829ed2243706f57574-23" href="#rest_code_6e1781c3b8a541829ed2243706f57574-23"></a>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-24" name="rest_code_6e1781c3b8a541829ed2243706f57574-24" href="#rest_code_6e1781c3b8a541829ed2243706f57574-24"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-25" name="rest_code_6e1781c3b8a541829ed2243706f57574-25" href="#rest_code_6e1781c3b8a541829ed2243706f57574-25"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-26" name="rest_code_6e1781c3b8a541829ed2243706f57574-26" href="#rest_code_6e1781c3b8a541829ed2243706f57574-26"></a><span class="k">end</span>
</pre></div>
<p>The reading speed should be slightly faster then writing speed in average. If the reader is interrupted for a brief
period of time, the data will be buffered in the RAM. When the reader returns to polling the data, it will catch up
with the writer. If the reader reaches the writer address, it will stop reading the data until the new data arrives.</p>
<p>I implemented the reader in a separate model since want to reuse it in different designs. Here is the verilog code for the reading part:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_087ba99ca91147f7aa3f781121a89a20-1" name="rest_code_087ba99ca91147f7aa3f781121a89a20-1" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-1"></a><span class="k">module</span><span class="w"> </span><span class="n">parallel_exchange_fsm</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-2" name="rest_code_087ba99ca91147f7aa3f781121a89a20-2" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-2"></a><span class="p">(</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-3" name="rest_code_087ba99ca91147f7aa3f781121a89a20-3" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-4" name="rest_code_087ba99ca91147f7aa3f781121a89a20-4" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-5" name="rest_code_087ba99ca91147f7aa3f781121a89a20-5" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-6" name="rest_code_087ba99ca91147f7aa3f781121a89a20-6" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-6"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-7" name="rest_code_087ba99ca91147f7aa3f781121a89a20-7" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-7"></a><span class="w">    </span><span class="c1">//Interraction with memory</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-8" name="rest_code_087ba99ca91147f7aa3f781121a89a20-8" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-8"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-9" name="rest_code_087ba99ca91147f7aa3f781121a89a20-9" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-9"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">r_en</span><span class="p">,</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-10" name="rest_code_087ba99ca91147f7aa3f781121a89a20-10" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">,</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-11" name="rest_code_087ba99ca91147f7aa3f781121a89a20-11" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-11"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-12" name="rest_code_087ba99ca91147f7aa3f781121a89a20-12" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-12"></a><span class="w">    </span><span class="c1">//Interraction with downstream device</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-13" name="rest_code_087ba99ca91147f7aa3f781121a89a20-13" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-13"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">data_req</span><span class="p">,</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-14" name="rest_code_087ba99ca91147f7aa3f781121a89a20-14" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-14"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_out</span><span class="p">,</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-15" name="rest_code_087ba99ca91147f7aa3f781121a89a20-15" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-15"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_ready</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-16" name="rest_code_087ba99ca91147f7aa3f781121a89a20-16" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-16"></a><span class="p">);</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-17" name="rest_code_087ba99ca91147f7aa3f781121a89a20-17" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-17"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-18" name="rest_code_087ba99ca91147f7aa3f781121a89a20-18" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-18"></a><span class="w">    </span><span class="c1">//Data request synchronization flip-flops</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-19" name="rest_code_087ba99ca91147f7aa3f781121a89a20-19" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-19"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-20" name="rest_code_087ba99ca91147f7aa3f781121a89a20-20" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-20"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_2</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-21" name="rest_code_087ba99ca91147f7aa3f781121a89a20-21" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-21"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-22" name="rest_code_087ba99ca91147f7aa3f781121a89a20-22" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-22"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b00</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-23" name="rest_code_087ba99ca91147f7aa3f781121a89a20-23" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-23"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b01</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-24" name="rest_code_087ba99ca91147f7aa3f781121a89a20-24" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-24"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b10</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-25" name="rest_code_087ba99ca91147f7aa3f781121a89a20-25" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-25"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b11</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-26" name="rest_code_087ba99ca91147f7aa3f781121a89a20-26" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-26"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-27" name="rest_code_087ba99ca91147f7aa3f781121a89a20-27" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-27"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">paralled_data_io_state</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-28" name="rest_code_087ba99ca91147f7aa3f781121a89a20-28" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-28"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-29" name="rest_code_087ba99ca91147f7aa3f781121a89a20-29" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-29"></a><span class="w">    </span><span class="c1">//This FSM handles parallel data output</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-30" name="rest_code_087ba99ca91147f7aa3f781121a89a20-30" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-30"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-31" name="rest_code_087ba99ca91147f7aa3f781121a89a20-31" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-32" name="rest_code_087ba99ca91147f7aa3f781121a89a20-32" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-32"></a><span class="w">            </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-33" name="rest_code_087ba99ca91147f7aa3f781121a89a20-33" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-33"></a><span class="w">            </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-34" name="rest_code_087ba99ca91147f7aa3f781121a89a20-34" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-34"></a><span class="w">            </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-35" name="rest_code_087ba99ca91147f7aa3f781121a89a20-35" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-35"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-36" name="rest_code_087ba99ca91147f7aa3f781121a89a20-36" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-36"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-37" name="rest_code_087ba99ca91147f7aa3f781121a89a20-37" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-37"></a><span class="w">        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-38" name="rest_code_087ba99ca91147f7aa3f781121a89a20-38" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-38"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-39" name="rest_code_087ba99ca91147f7aa3f781121a89a20-39" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-39"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-40" name="rest_code_087ba99ca91147f7aa3f781121a89a20-40" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-40"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">paralled_data_io_state</span><span class="p">)</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-41" name="rest_code_087ba99ca91147f7aa3f781121a89a20-41" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-41"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_HIGH:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-42" name="rest_code_087ba99ca91147f7aa3f781121a89a20-42" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-42"></a><span class="w">                    </span><span class="n">r_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span><span class="w">  </span><span class="c1">//Just keep r_en high all the time for simplicity</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-43" name="rest_code_087ba99ca91147f7aa3f781121a89a20-43" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-43"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">data_req_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-44" name="rest_code_087ba99ca91147f7aa3f781121a89a20-44" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-44"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-45" name="rest_code_087ba99ca91147f7aa3f781121a89a20-45" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-45"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-46" name="rest_code_087ba99ca91147f7aa3f781121a89a20-46" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-46"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-47" name="rest_code_087ba99ca91147f7aa3f781121a89a20-47" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-47"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-48" name="rest_code_087ba99ca91147f7aa3f781121a89a20-48" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-48"></a><span class="w">                </span><span class="nl">WAITING_DATA_AWAIL:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-49" name="rest_code_087ba99ca91147f7aa3f781121a89a20-49" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-49"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r_addr</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">//Data available in the buffer</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-50" name="rest_code_087ba99ca91147f7aa3f781121a89a20-50" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-50"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-51" name="rest_code_087ba99ca91147f7aa3f781121a89a20-51" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-51"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-52" name="rest_code_087ba99ca91147f7aa3f781121a89a20-52" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-52"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-53" name="rest_code_087ba99ca91147f7aa3f781121a89a20-53" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-53"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-54" name="rest_code_087ba99ca91147f7aa3f781121a89a20-54" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-54"></a><span class="w">                </span><span class="nl">READING_BUFFER:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-55" name="rest_code_087ba99ca91147f7aa3f781121a89a20-55" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-55"></a><span class="w">                    </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">r_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-56" name="rest_code_087ba99ca91147f7aa3f781121a89a20-56" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-56"></a><span class="w">                    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-57" name="rest_code_087ba99ca91147f7aa3f781121a89a20-57" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-57"></a><span class="w">                    </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-58" name="rest_code_087ba99ca91147f7aa3f781121a89a20-58" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-58"></a><span class="w">                    </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-59" name="rest_code_087ba99ca91147f7aa3f781121a89a20-59" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-59"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-60" name="rest_code_087ba99ca91147f7aa3f781121a89a20-60" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-60"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-61" name="rest_code_087ba99ca91147f7aa3f781121a89a20-61" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-61"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_LOW:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-62" name="rest_code_087ba99ca91147f7aa3f781121a89a20-62" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-62"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">data_req_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-63" name="rest_code_087ba99ca91147f7aa3f781121a89a20-63" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-63"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-64" name="rest_code_087ba99ca91147f7aa3f781121a89a20-64" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-64"></a><span class="w">                        </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-65" name="rest_code_087ba99ca91147f7aa3f781121a89a20-65" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-65"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-66" name="rest_code_087ba99ca91147f7aa3f781121a89a20-66" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-66"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-67" name="rest_code_087ba99ca91147f7aa3f781121a89a20-67" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-67"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-68" name="rest_code_087ba99ca91147f7aa3f781121a89a20-68" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-68"></a><span class="w">            </span><span class="k">endcase</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-69" name="rest_code_087ba99ca91147f7aa3f781121a89a20-69" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-69"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-70" name="rest_code_087ba99ca91147f7aa3f781121a89a20-70" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-70"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-71" name="rest_code_087ba99ca91147f7aa3f781121a89a20-71" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-71"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-72" name="rest_code_087ba99ca91147f7aa3f781121a89a20-72" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-72"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-73" name="rest_code_087ba99ca91147f7aa3f781121a89a20-73" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-73"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-74" name="rest_code_087ba99ca91147f7aa3f781121a89a20-74" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-74"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-75" name="rest_code_087ba99ca91147f7aa3f781121a89a20-75" href="#rest_code_087ba99ca91147f7aa3f781121a89a20-75"></a><span class="k">endmodule</span>
</pre></div>
<p>Note that if there is no data in the buffer, <code>r_addr == w_addr</code>, the reader will stick in the <code>WAITING_DATA_AWAIL</code> state until the new data arrives.
This is how we use it in the top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-1" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-1" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-1"></a><span class="n">parallel_exchange_fsm</span><span class="w"> </span><span class="n">parallel_exchange_fsm_inst</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-2" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-2" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-2"></a><span class="p">(</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-3" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-3" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-3"></a><span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-4" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-4" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-4"></a><span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-5" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-5" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-5"></a><span class="w">    </span><span class="p">.</span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-6" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-6" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-6"></a>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-7" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-7" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-7"></a><span class="c1">//Interaction with memory</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-8" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-8" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-8"></a><span class="w">    </span><span class="p">.</span><span class="n">r_addr</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-9" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-9" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-9"></a><span class="w">    </span><span class="p">.</span><span class="n">r_en</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-10" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-10" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-10"></a><span class="w">    </span><span class="p">.</span><span class="n">memory_read_value</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">),</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-11" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-11" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-11"></a>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-12" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-12" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-12"></a><span class="c1">//Interaction with downstream device</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-13" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-13" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-13"></a><span class="w">    </span><span class="p">.</span><span class="n">data_req</span><span class="p">(</span><span class="n">data_req</span><span class="p">),</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-14" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-14" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-14"></a><span class="w">    </span><span class="p">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">data_out</span><span class="p">),</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-15" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-15" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-15"></a><span class="w">    </span><span class="p">.</span><span class="n">data_ready</span><span class="p">(</span><span class="n">data_rdy</span><span class="p">)</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-16" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-16" href="#rest_code_fff2430e10434c7e90809dceb9f53a7f-16"></a><span class="p">);</span>
</pre></div>
</section><section id="tests-and-results"><h2>Tests and results</h2>
<p>First of all we need to double check that the synthesis tool could infer the RAM blocks. We can do this by looking at the synthesis report generated by
apio build command in "verbose" mode.</p>
<div class="code"><pre class="code bash"><a id="rest_code_b6a525c2447f41e99165940d118b5468-1" name="rest_code_b6a525c2447f41e99165940d118b5468-1" href="#rest_code_b6a525c2447f41e99165940d118b5468-1"></a>apio<span class="w"> </span>build<span class="w"> </span>--verbose
<a id="rest_code_b6a525c2447f41e99165940d118b5468-2" name="rest_code_b6a525c2447f41e99165940d118b5468-2" href="#rest_code_b6a525c2447f41e99165940d118b5468-2"></a>
<a id="rest_code_b6a525c2447f41e99165940d118b5468-3" name="rest_code_b6a525c2447f41e99165940d118b5468-3" href="#rest_code_b6a525c2447f41e99165940d118b5468-3"></a>....Skipping<span class="w"> </span>some<span class="w"> </span><span class="o">(</span>a<span class="w"> </span>lot<span class="w"> </span>of<span class="o">)</span><span class="w"> </span>output...
<a id="rest_code_b6a525c2447f41e99165940d118b5468-4" name="rest_code_b6a525c2447f41e99165940d118b5468-4" href="#rest_code_b6a525c2447f41e99165940d118b5468-4"></a>
<a id="rest_code_b6a525c2447f41e99165940d118b5468-5" name="rest_code_b6a525c2447f41e99165940d118b5468-5" href="#rest_code_b6a525c2447f41e99165940d118b5468-5"></a>Info:<span class="w"> </span>Device<span class="w"> </span>utilisation:
<a id="rest_code_b6a525c2447f41e99165940d118b5468-6" name="rest_code_b6a525c2447f41e99165940d118b5468-6" href="#rest_code_b6a525c2447f41e99165940d118b5468-6"></a>Info:<span class="w">            </span>ICESTORM_LC:<span class="w">   </span><span class="m">100</span>/<span class="w"> </span><span class="m">1280</span><span class="w">     </span><span class="m">7</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-7" name="rest_code_b6a525c2447f41e99165940d118b5468-7" href="#rest_code_b6a525c2447f41e99165940d118b5468-7"></a>Info:<span class="w">           </span>ICESTORM_RAM:<span class="w">     </span><span class="m">3</span>/<span class="w">   </span><span class="m">16</span><span class="w">    </span><span class="m">18</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-8" name="rest_code_b6a525c2447f41e99165940d118b5468-8" href="#rest_code_b6a525c2447f41e99165940d118b5468-8"></a>Info:<span class="w">                  </span>SB_IO:<span class="w">    </span><span class="m">28</span>/<span class="w">  </span><span class="m">112</span><span class="w">    </span><span class="m">25</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-9" name="rest_code_b6a525c2447f41e99165940d118b5468-9" href="#rest_code_b6a525c2447f41e99165940d118b5468-9"></a>Info:<span class="w">                  </span>SB_GB:<span class="w">     </span><span class="m">4</span>/<span class="w">    </span><span class="m">8</span><span class="w">    </span><span class="m">50</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-10" name="rest_code_b6a525c2447f41e99165940d118b5468-10" href="#rest_code_b6a525c2447f41e99165940d118b5468-10"></a>Info:<span class="w">           </span>ICESTORM_PLL:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-11" name="rest_code_b6a525c2447f41e99165940d118b5468-11" href="#rest_code_b6a525c2447f41e99165940d118b5468-11"></a>Info:<span class="w">            </span>SB_WARMBOOT:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
</pre></div>
<p>Look for the "ICESTORM_RAM" line. We consumed 3 RAM blocks as expected, so the synthesis tool inferred the RAM blocks correctly.</p>
<p>The C part is almost the same as in the previous article, the only difference is that we read few hundres/few thousands of samples from the device and print the data instead of storing it in the binary file:</p>
<div class="code"><pre class="code C"><a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2"></a><span class="w">    </span><span class="c1">//Reading 500Mb of data from the GPIO</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2500</span><span class="p">;</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">samples_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5"></a><span class="w">    </span><span class="n">poll_data_from_gpio</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">samples_count</span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6"></a>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7"></a><span class="w">    </span><span class="c1">//Calculate the ticks difference between each sample in place</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"%02X %02X %02X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">)</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14"></a><span class="w">        </span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16"></a>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18" href="#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18"></a><span class="p">}</span>
</pre></div>
<p>Compile and test the code:</p>
<div class="code"><pre class="code bash"><a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-1" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-1" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-1"></a>&gt;gcci<span class="w"> </span>-o3<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-o<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.c
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-2" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-2" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-2"></a>&gt;sudo<span class="w"> </span>./test
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-3" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-3" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-3"></a>Done<span class="w"> </span>!!!
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-4" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-4" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-4"></a>FF<span class="w"> </span>FF<span class="w"> </span>1F
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-5" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-5" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-5"></a>FE<span class="w"> </span>FE<span class="w"> </span>1E
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-6" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-6" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-6"></a>FD<span class="w"> </span>FD<span class="w"> </span>1D
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-7" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-7" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-7"></a>FC<span class="w"> </span>FC<span class="w"> </span>1C
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-8" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-8" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-8"></a>FB<span class="w"> </span>FB<span class="w"> </span>1B
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-9" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-9" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-9"></a>FA<span class="w"> </span>FA<span class="w"> </span>1A
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-10" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-10" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-10"></a>F9<span class="w"> </span>F9<span class="w"> </span><span class="m">19</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-11" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-11" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-11"></a>F8<span class="w"> </span>F8<span class="w"> </span><span class="m">18</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-12" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-12" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-12"></a>F7<span class="w"> </span>F7<span class="w"> </span><span class="m">17</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-13" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-13" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-13"></a>F6<span class="w"> </span>F6<span class="w"> </span><span class="m">16</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-14" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-14" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-14"></a>F5<span class="w"> </span>F5<span class="w"> </span><span class="m">15</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-15" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-15" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-15"></a>F4<span class="w"> </span>F4<span class="w"> </span><span class="m">14</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-16" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-16" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-16"></a>F3<span class="w"> </span>F3<span class="w"> </span><span class="m">13</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-17" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-17" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-17"></a>F2<span class="w"> </span>F2<span class="w"> </span><span class="m">12</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-18" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-18" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-18"></a>F1<span class="w"> </span>F1<span class="w"> </span><span class="m">11</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-19" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-19" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-19"></a>F0<span class="w"> </span>F0<span class="w"> </span><span class="m">10</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-20" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-20" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-20"></a>EF<span class="w"> </span>EF<span class="w"> </span>0F
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-21" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-21" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-21"></a>EE<span class="w"> </span>EE<span class="w"> </span>0E
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-22" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-22" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-22"></a>ED<span class="w"> </span>ED<span class="w"> </span>0D
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-23" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-23" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-23"></a>EC<span class="w"> </span>EC<span class="w"> </span>0C
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-24" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-24" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-24"></a>EB<span class="w"> </span>EB<span class="w"> </span>0B
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-25" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-25" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-25"></a>EA<span class="w"> </span>EA<span class="w"> </span>0A
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-26" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-26" href="#rest_code_14a8f0765a904c139e6ef8f983eae8c6-26"></a>E9<span class="w"> </span>E9<span class="w"> </span><span class="m">09</span>
</pre></div>
<p>The data is read correctly, hooray!</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>We learned how to use RAM in iCE40 FPGA and implemented FIFO buffer. In the next article, we will learn how to read the data from multiple I2S microphones
and push it into the FIFO buffer. Stay tuned!</p>
</section>
</div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/" rel="prev" title="FPGA-Driven data streaming into Raspberry Pi through GPIO: Speed and timing stability.">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    


        </section></article><!--End of body content--><footer id="footer">
            Contents  2024         <a href="mailto:alexandr.savochkin@gmail.com">Alex Savochkin</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
