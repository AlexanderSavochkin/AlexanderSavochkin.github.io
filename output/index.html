<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="I write about a variety of topics, primarily focusing on programming, embedded systems, do-it-yourself (DIY) projects, robotics, and machine learning (ML).">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Alex Savochkin</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://alexandersavochkin.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">Alex Savochkin</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="pages/about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/" class="u-url">Streaming data from FPGA: Using on-chip block RAM as buffer.</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Alex Savochkin
                    </span></p>
            <p class="dateline">
            <a href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/" rel="bookmark">
            <time class="published dt-published" datetime="2024-03-24T22:17:28-07:00" itemprop="datePublished" title="2024-03-24 22:17">2024-03-24 22:17</time></a>
            </p>
                        <p class="commentline">
    


                </p>
</div>
            </header><div class="e-content entry-content">
                    <section id="introduction"><h2>Introduction</h2>
<p>This post continues the series of posts describing experiments with using FPGA as a high speed (millions of samples per second)
data capturing device and continues my previous post, where we defined the exchange protocol and measured timing. As I
concluded in that post, we need to have a buffer on the capturing device side which can hold the samples is the computer
reading the data temporary stops polling the data due to handling OS interrupts.</p>
<p>Conveniently, FPGAs typically have RAM on the chip which can be used for builing such a buffer, and we will explore how
to use it in this post. We will create a simple data generator which will simulate the data and write it into the buffer,
and then read the data from the buffer and transfer it into the parallel bus.</p>
<p>This test program partially implements my project of building a microphone array with multiple INMP441 microphones
connected to the FPGA, which I briefly describe in the next section.</p>
</section><section id="high-level-design-overview"><h2>High level design overview</h2>
<p>Here is the diagram of the digital device I am having in mind</p>
<img alt="/images/microphone-array-simulation.png" src="images/microphone-array-simulation.png" style="width: 1034.0px; height: 785.0px;"><p>According to out estimation we need buffer of size &gt; 260 samples, we will implement 512 samples buffer which
will have and extra space which helps to cover cases when two interrupts comming almost simultaneously.</p>
<p>The iCE40HX1K chip has 16 blocks of RAM 4096 bits (512 bytes) each.
Each block can be configured for storing 256 x 16-bit, 512 x 8-bit bytes, 1024 x 4-bit or 2048 x 2-bit memory cell.
Since I am aiming to capture 24-bit samples from multiple INMP441 microphones, my samples are 24-bit wide, so in
order to utilize the memory efficiently I decided to use 3 blocks configured as 512x8:  1st block will keep bits
0..7, 2nd block will keep bits 8..15 and 3rd block will keep bits 16..23.</p>
<p>We will design the multiple I2S capturing part in the next posts, today we will replace it with a simulated data
which will be written into the circular buffer and focus on data reading and transferring into the parallel bus.</p>
<p>The exchange protocol is the same is in the time measurment setup described in the previous post: the "device"
(FPGA) waits for the rising edge of the "Data Req" (data request) line and sets its 21-bit data output, but this
time it reads it from the memory instead of using timer value. Then the "device" sets the "Data Rdy" (data ready)
line to HIGH. The polling program detects the change in the "Data Rdy"  line, reads and records the 21-bit data value from
the parallel bus, and then sets "Data Req" to low on the SBC. This signals to the device that the SBC has successfully
read the data, prompting it to set "Data Rdy" to low. The polling program detects the falling edge of the "Data Rdy"
line and proceeds to the next cycle iteration.</p>
<p>Previously we used the timer value as the data, it is pretty much the same in this design, but the timer value is written
the FIFO buffer and the reading part of the system gets in from the reading side of the FIFO and sends to thr parallel bus.</p>
<p>The timer is 8-bit wide now, we repeat it 3 times to get 24-bit value, so the data should be least significant 21 bytes
of the 24-bit value &lt;Timer[7:0], Timer[7:0], Timer[7:0]&gt;. As a quick reminder we are using 21-bit data value because
we run out of pins on iCEstick board.</p>
</section><section id="verilog-implementation"><h2>Verilog implementation</h2>
<p>I think there are modules similar to PLL (see the previous post) which can be used for defining the RAM block in Verilog.
<a class="reference external" href="https://www.latticesemi.com/-/media/LatticeSemi/Documents/ApplicationNotes/MO/MemoryUsageGuideforiCE40Devices.ashx?document_id=47775">The Memory Usage Guide for iCE40 Devices</a>
mentions the <cite>SB_RAM512x8</cite>, <cite>SB_RAM1024x4</cite> modules, but I think they are Lattice/iCE40-specific and I am not sure how to use them with apio.</p>
<p>There is also another, more portable way to infer RAM blocks in Verilog, which is supported by most of the FPGA synthesis tools.
We will follow this way in our design. The following code snippet shows how to define a 512x8 memory block in Verilog
which can be inferred as a Block RAM by the synthesis tool.</p>
<div class="code"><pre class="code verilog"><a id="rest_code_6081c69e5daa4e4fbfaf796627186778-1" name="rest_code_6081c69e5daa4e4fbfaf796627186778-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-1"></a><span class="k">module</span><span class="w"> </span><span class="n">ram512x8</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-2" name="rest_code_6081c69e5daa4e4fbfaf796627186778-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-2"></a><span class="p">(</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-3" name="rest_code_6081c69e5daa4e4fbfaf796627186778-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RADDR</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-4" name="rest_code_6081c69e5daa4e4fbfaf796627186778-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RCLK</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-5" name="rest_code_6081c69e5daa4e4fbfaf796627186778-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RE</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-6" name="rest_code_6081c69e5daa4e4fbfaf796627186778-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RDATA</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-7" name="rest_code_6081c69e5daa4e4fbfaf796627186778-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WDATA</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-8" name="rest_code_6081c69e5daa4e4fbfaf796627186778-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-8"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WADDR</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-9" name="rest_code_6081c69e5daa4e4fbfaf796627186778-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-9"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WCLK</span><span class="p">,</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-10" name="rest_code_6081c69e5daa4e4fbfaf796627186778-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WE</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-11" name="rest_code_6081c69e5daa4e4fbfaf796627186778-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-11"></a><span class="p">);</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-12" name="rest_code_6081c69e5daa4e4fbfaf796627186778-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-12"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">511</span><span class="p">];</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-13" name="rest_code_6081c69e5daa4e4fbfaf796627186778-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-13"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-14" name="rest_code_6081c69e5daa4e4fbfaf796627186778-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-14"></a><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-15" name="rest_code_6081c69e5daa4e4fbfaf796627186778-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-15"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-16" name="rest_code_6081c69e5daa4e4fbfaf796627186778-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-16"></a><span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-17" name="rest_code_6081c69e5daa4e4fbfaf796627186778-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-17"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">512</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="c1">// start with blank memory with 0 instead of x so that we can infer Yosys for BRAM.</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-18" name="rest_code_6081c69e5daa4e4fbfaf796627186778-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-18"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">'d0</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-19" name="rest_code_6081c69e5daa4e4fbfaf796627186778-19" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-19"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-20" name="rest_code_6081c69e5daa4e4fbfaf796627186778-20" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-20"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-21" name="rest_code_6081c69e5daa4e4fbfaf796627186778-21" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-21"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">RCLK</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-22" name="rest_code_6081c69e5daa4e4fbfaf796627186778-22" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-22"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-23" name="rest_code_6081c69e5daa4e4fbfaf796627186778-23" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RE</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-24" name="rest_code_6081c69e5daa4e4fbfaf796627186778-24" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-24"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-25" name="rest_code_6081c69e5daa4e4fbfaf796627186778-25" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-25"></a><span class="w">            </span><span class="n">RDATA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">RADDR</span><span class="p">];</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-26" name="rest_code_6081c69e5daa4e4fbfaf796627186778-26" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-26"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-27" name="rest_code_6081c69e5daa4e4fbfaf796627186778-27" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-27"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-28" name="rest_code_6081c69e5daa4e4fbfaf796627186778-28" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-28"></a>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-29" name="rest_code_6081c69e5daa4e4fbfaf796627186778-29" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-29"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">WCLK</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-30" name="rest_code_6081c69e5daa4e4fbfaf796627186778-30" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-30"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-31" name="rest_code_6081c69e5daa4e4fbfaf796627186778-31" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WE</span><span class="p">)</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-32" name="rest_code_6081c69e5daa4e4fbfaf796627186778-32" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-32"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-33" name="rest_code_6081c69e5daa4e4fbfaf796627186778-33" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-33"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">WADDR</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WDATA</span><span class="p">;</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-34" name="rest_code_6081c69e5daa4e4fbfaf796627186778-34" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-34"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-35" name="rest_code_6081c69e5daa4e4fbfaf796627186778-35" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-35"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6081c69e5daa4e4fbfaf796627186778-36" name="rest_code_6081c69e5daa4e4fbfaf796627186778-36" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6081c69e5daa4e4fbfaf796627186778-36"></a><span class="k">endmodule</span>
</pre></div>
<p>When the synthesis tool sees an array of registers with a specific read and write access pattern, which matches the
RAM block (like one above), it will infer the RAM block instead of using the LUTs.</p>
<p>Here is how we define the buffer in our top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-1"></a><span class="c1">//Define memory access signals</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-2"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-3"></a><span class="kt">wire</span><span class="w"> </span><span class="n">r_en</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-4"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-5"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-6"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_data</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-7"></a><span class="kt">reg</span><span class="w"> </span><span class="n">w_en</span><span class="p">;</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-8"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-9"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-10"></a><span class="c1">//We will use 3 blocks of 512x8 RAM to store 24-bit samples</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-11"></a><span class="c1">//Each the blocks share read address (r_addr), write address (w_addr),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-12"></a><span class="c1">//write enable (w_en) and read enable (r_en) signals. We write the same</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-13"></a><span class="c1">//value to all 3 blocks, (since it is simulated data), and read the data into</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-14"></a><span class="c1">//different bits of the memory_read_value signal.</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-15"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-16"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_0</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-17"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-18"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-19"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-20"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-21"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-22"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-23"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-24"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-25"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-26"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-27"></a><span class="p">);</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-28"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-29"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_1</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-30"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-31"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-32"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-33"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-34"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-35"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-36"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-37"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-38"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-39"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-40"></a><span class="p">);</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-41"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-42"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_2</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-43"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">]),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-44"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-45"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-46"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-47"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-48"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-49"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-50"></a>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-51"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-52"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53" name="rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_baf7a30d309f4ef7b073b6ca4c11c8b5-53"></a><span class="p">);</span>
</pre></div>
<p>The simulation part is pretty simple, we generate the data and write it into each buffer:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_6e1781c3b8a541829ed2243706f57574-1" name="rest_code_6e1781c3b8a541829ed2243706f57574-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-1"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w">  </span><span class="c1">//Controls stage of writing data into the buffer</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-2" name="rest_code_6e1781c3b8a541829ed2243706f57574-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-2"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter2</span><span class="p">;</span><span class="w"> </span><span class="c1">//Counter representing the simulated data</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-3" name="rest_code_6e1781c3b8a541829ed2243706f57574-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-3"></a>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-4" name="rest_code_6e1781c3b8a541829ed2243706f57574-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-4"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">ref_clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-5" name="rest_code_6e1781c3b8a541829ed2243706f57574-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-6" name="rest_code_6e1781c3b8a541829ed2243706f57574-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-6"></a><span class="w">        </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-7" name="rest_code_6e1781c3b8a541829ed2243706f57574-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-7"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-8" name="rest_code_6e1781c3b8a541829ed2243706f57574-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-8"></a><span class="w">        </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-9" name="rest_code_6e1781c3b8a541829ed2243706f57574-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-9"></a><span class="w">        </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-10" name="rest_code_6e1781c3b8a541829ed2243706f57574-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-10"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-11" name="rest_code_6e1781c3b8a541829ed2243706f57574-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-11"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-12" name="rest_code_6e1781c3b8a541829ed2243706f57574-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-13" name="rest_code_6e1781c3b8a541829ed2243706f57574-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-13"></a><span class="w">            </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-14" name="rest_code_6e1781c3b8a541829ed2243706f57574-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-14"></a><span class="w">            </span><span class="n">w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">~</span><span class="n">counter2</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-15" name="rest_code_6e1781c3b8a541829ed2243706f57574-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-15"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-16" name="rest_code_6e1781c3b8a541829ed2243706f57574-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-16"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-17" name="rest_code_6e1781c3b8a541829ed2243706f57574-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-17"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">5</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-18" name="rest_code_6e1781c3b8a541829ed2243706f57574-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-18"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-19" name="rest_code_6e1781c3b8a541829ed2243706f57574-19" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-19"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">6</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-20" name="rest_code_6e1781c3b8a541829ed2243706f57574-20" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-20"></a><span class="w">            </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-21" name="rest_code_6e1781c3b8a541829ed2243706f57574-21" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-21"></a><span class="w">            </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">w_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-22" name="rest_code_6e1781c3b8a541829ed2243706f57574-22" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-22"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-23" name="rest_code_6e1781c3b8a541829ed2243706f57574-23" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-23"></a>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-24" name="rest_code_6e1781c3b8a541829ed2243706f57574-24" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-24"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-25" name="rest_code_6e1781c3b8a541829ed2243706f57574-25" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-25"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_6e1781c3b8a541829ed2243706f57574-26" name="rest_code_6e1781c3b8a541829ed2243706f57574-26" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_6e1781c3b8a541829ed2243706f57574-26"></a><span class="k">end</span>
</pre></div>
<p>The reading speed should be slightly faster then writing speed in average. If the reader is interrupted for a brief
period of time, the data will be buffered in the RAM. When the reader returns to polling the data, it will catch up
with the writer. If the reader reaches the writer address, it will stop reading the data until the new data arrives.</p>
<p>I implemented the reader in a separate model since want to reuse it in different designs. Here is the verilog code for the reading part:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_087ba99ca91147f7aa3f781121a89a20-1" name="rest_code_087ba99ca91147f7aa3f781121a89a20-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-1"></a><span class="k">module</span><span class="w"> </span><span class="n">parallel_exchange_fsm</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-2" name="rest_code_087ba99ca91147f7aa3f781121a89a20-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-2"></a><span class="p">(</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-3" name="rest_code_087ba99ca91147f7aa3f781121a89a20-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-4" name="rest_code_087ba99ca91147f7aa3f781121a89a20-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-5" name="rest_code_087ba99ca91147f7aa3f781121a89a20-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-6" name="rest_code_087ba99ca91147f7aa3f781121a89a20-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-6"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-7" name="rest_code_087ba99ca91147f7aa3f781121a89a20-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-7"></a><span class="w">    </span><span class="c1">//Interraction with memory</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-8" name="rest_code_087ba99ca91147f7aa3f781121a89a20-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-8"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-9" name="rest_code_087ba99ca91147f7aa3f781121a89a20-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-9"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">r_en</span><span class="p">,</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-10" name="rest_code_087ba99ca91147f7aa3f781121a89a20-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">,</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-11" name="rest_code_087ba99ca91147f7aa3f781121a89a20-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-11"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-12" name="rest_code_087ba99ca91147f7aa3f781121a89a20-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-12"></a><span class="w">    </span><span class="c1">//Interraction with downstream device</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-13" name="rest_code_087ba99ca91147f7aa3f781121a89a20-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-13"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">data_req</span><span class="p">,</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-14" name="rest_code_087ba99ca91147f7aa3f781121a89a20-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-14"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_out</span><span class="p">,</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-15" name="rest_code_087ba99ca91147f7aa3f781121a89a20-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-15"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_ready</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-16" name="rest_code_087ba99ca91147f7aa3f781121a89a20-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-16"></a><span class="p">);</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-17" name="rest_code_087ba99ca91147f7aa3f781121a89a20-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-17"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-18" name="rest_code_087ba99ca91147f7aa3f781121a89a20-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-18"></a><span class="w">    </span><span class="c1">//Data request synchronization flip-flops</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-19" name="rest_code_087ba99ca91147f7aa3f781121a89a20-19" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-19"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-20" name="rest_code_087ba99ca91147f7aa3f781121a89a20-20" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-20"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_2</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-21" name="rest_code_087ba99ca91147f7aa3f781121a89a20-21" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-21"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-22" name="rest_code_087ba99ca91147f7aa3f781121a89a20-22" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-22"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b00</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-23" name="rest_code_087ba99ca91147f7aa3f781121a89a20-23" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-23"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b01</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-24" name="rest_code_087ba99ca91147f7aa3f781121a89a20-24" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-24"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b10</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-25" name="rest_code_087ba99ca91147f7aa3f781121a89a20-25" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-25"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b11</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-26" name="rest_code_087ba99ca91147f7aa3f781121a89a20-26" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-26"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-27" name="rest_code_087ba99ca91147f7aa3f781121a89a20-27" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-27"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">paralled_data_io_state</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-28" name="rest_code_087ba99ca91147f7aa3f781121a89a20-28" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-28"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-29" name="rest_code_087ba99ca91147f7aa3f781121a89a20-29" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-29"></a><span class="w">    </span><span class="c1">//This FSM handles parallel data output</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-30" name="rest_code_087ba99ca91147f7aa3f781121a89a20-30" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-30"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-31" name="rest_code_087ba99ca91147f7aa3f781121a89a20-31" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-32" name="rest_code_087ba99ca91147f7aa3f781121a89a20-32" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-32"></a><span class="w">            </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-33" name="rest_code_087ba99ca91147f7aa3f781121a89a20-33" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-33"></a><span class="w">            </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-34" name="rest_code_087ba99ca91147f7aa3f781121a89a20-34" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-34"></a><span class="w">            </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-35" name="rest_code_087ba99ca91147f7aa3f781121a89a20-35" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-35"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-36" name="rest_code_087ba99ca91147f7aa3f781121a89a20-36" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-36"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-37" name="rest_code_087ba99ca91147f7aa3f781121a89a20-37" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-37"></a><span class="w">        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">2</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-38" name="rest_code_087ba99ca91147f7aa3f781121a89a20-38" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-38"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-39" name="rest_code_087ba99ca91147f7aa3f781121a89a20-39" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-39"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-40" name="rest_code_087ba99ca91147f7aa3f781121a89a20-40" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-40"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">paralled_data_io_state</span><span class="p">)</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-41" name="rest_code_087ba99ca91147f7aa3f781121a89a20-41" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-41"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_HIGH:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-42" name="rest_code_087ba99ca91147f7aa3f781121a89a20-42" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-42"></a><span class="w">                    </span><span class="n">r_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span><span class="w">  </span><span class="c1">//Just keep r_en high all the time for simplicity</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-43" name="rest_code_087ba99ca91147f7aa3f781121a89a20-43" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-43"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">data_req_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-44" name="rest_code_087ba99ca91147f7aa3f781121a89a20-44" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-44"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-45" name="rest_code_087ba99ca91147f7aa3f781121a89a20-45" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-45"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-46" name="rest_code_087ba99ca91147f7aa3f781121a89a20-46" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-46"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-47" name="rest_code_087ba99ca91147f7aa3f781121a89a20-47" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-47"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-48" name="rest_code_087ba99ca91147f7aa3f781121a89a20-48" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-48"></a><span class="w">                </span><span class="nl">WAITING_DATA_AWAIL:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-49" name="rest_code_087ba99ca91147f7aa3f781121a89a20-49" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-49"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r_addr</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">//Data available in the buffer</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-50" name="rest_code_087ba99ca91147f7aa3f781121a89a20-50" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-50"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-51" name="rest_code_087ba99ca91147f7aa3f781121a89a20-51" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-51"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-52" name="rest_code_087ba99ca91147f7aa3f781121a89a20-52" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-52"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-53" name="rest_code_087ba99ca91147f7aa3f781121a89a20-53" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-53"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-54" name="rest_code_087ba99ca91147f7aa3f781121a89a20-54" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-54"></a><span class="w">                </span><span class="nl">READING_BUFFER:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-55" name="rest_code_087ba99ca91147f7aa3f781121a89a20-55" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-55"></a><span class="w">                    </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">r_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-56" name="rest_code_087ba99ca91147f7aa3f781121a89a20-56" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-56"></a><span class="w">                    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-57" name="rest_code_087ba99ca91147f7aa3f781121a89a20-57" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-57"></a><span class="w">                    </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-58" name="rest_code_087ba99ca91147f7aa3f781121a89a20-58" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-58"></a><span class="w">                    </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-59" name="rest_code_087ba99ca91147f7aa3f781121a89a20-59" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-59"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-60" name="rest_code_087ba99ca91147f7aa3f781121a89a20-60" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-60"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-61" name="rest_code_087ba99ca91147f7aa3f781121a89a20-61" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-61"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_LOW:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-62" name="rest_code_087ba99ca91147f7aa3f781121a89a20-62" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-62"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">data_req_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-63" name="rest_code_087ba99ca91147f7aa3f781121a89a20-63" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-63"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-64" name="rest_code_087ba99ca91147f7aa3f781121a89a20-64" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-64"></a><span class="w">                        </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-65" name="rest_code_087ba99ca91147f7aa3f781121a89a20-65" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-65"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-66" name="rest_code_087ba99ca91147f7aa3f781121a89a20-66" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-66"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-67" name="rest_code_087ba99ca91147f7aa3f781121a89a20-67" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-67"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-68" name="rest_code_087ba99ca91147f7aa3f781121a89a20-68" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-68"></a><span class="w">            </span><span class="k">endcase</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-69" name="rest_code_087ba99ca91147f7aa3f781121a89a20-69" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-69"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-70" name="rest_code_087ba99ca91147f7aa3f781121a89a20-70" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-70"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-71" name="rest_code_087ba99ca91147f7aa3f781121a89a20-71" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-71"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-72" name="rest_code_087ba99ca91147f7aa3f781121a89a20-72" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-72"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-73" name="rest_code_087ba99ca91147f7aa3f781121a89a20-73" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-73"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-74" name="rest_code_087ba99ca91147f7aa3f781121a89a20-74" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-74"></a>
<a id="rest_code_087ba99ca91147f7aa3f781121a89a20-75" name="rest_code_087ba99ca91147f7aa3f781121a89a20-75" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_087ba99ca91147f7aa3f781121a89a20-75"></a><span class="k">endmodule</span>
</pre></div>
<p>Note that if there is no data in the buffer, <code>r_addr == w_addr</code>, the reader will stick in the <code>WAITING_DATA_AWAIL</code> state until the new data arrives.
This is how we use it in the top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-1" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-1"></a><span class="n">parallel_exchange_fsm</span><span class="w"> </span><span class="n">parallel_exchange_fsm_inst</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-2" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-2"></a><span class="p">(</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-3" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-3"></a><span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-4" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-4"></a><span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-5" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-5"></a><span class="w">    </span><span class="p">.</span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-6" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-6"></a>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-7" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-7"></a><span class="c1">//Interaction with memory</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-8" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-8"></a><span class="w">    </span><span class="p">.</span><span class="n">r_addr</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-9" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-9"></a><span class="w">    </span><span class="p">.</span><span class="n">r_en</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-10" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-10"></a><span class="w">    </span><span class="p">.</span><span class="n">memory_read_value</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">),</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-11" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-11"></a>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-12" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-12"></a><span class="c1">//Interaction with downstream device</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-13" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-13"></a><span class="w">    </span><span class="p">.</span><span class="n">data_req</span><span class="p">(</span><span class="n">data_req</span><span class="p">),</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-14" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-14"></a><span class="w">    </span><span class="p">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">data_out</span><span class="p">),</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-15" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-15"></a><span class="w">    </span><span class="p">.</span><span class="n">data_ready</span><span class="p">(</span><span class="n">data_rdy</span><span class="p">)</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_fff2430e10434c7e90809dceb9f53a7f-16" name="rest_code_fff2430e10434c7e90809dceb9f53a7f-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_fff2430e10434c7e90809dceb9f53a7f-16"></a><span class="p">);</span>
</pre></div>
</section><section id="tests-and-results"><h2>Tests and results</h2>
<p>First of all we need to double check that the synthesis tool could infer the RAM blocks. We can do this by looking at the synthesis report generated by
apio build command in "verbose" mode.</p>
<div class="code"><pre class="code bash"><a id="rest_code_b6a525c2447f41e99165940d118b5468-1" name="rest_code_b6a525c2447f41e99165940d118b5468-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-1"></a>apio<span class="w"> </span>build<span class="w"> </span>--verbose
<a id="rest_code_b6a525c2447f41e99165940d118b5468-2" name="rest_code_b6a525c2447f41e99165940d118b5468-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-2"></a>
<a id="rest_code_b6a525c2447f41e99165940d118b5468-3" name="rest_code_b6a525c2447f41e99165940d118b5468-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-3"></a>....Skipping<span class="w"> </span>some<span class="w"> </span><span class="o">(</span>a<span class="w"> </span>lot<span class="w"> </span>of<span class="o">)</span><span class="w"> </span>output...
<a id="rest_code_b6a525c2447f41e99165940d118b5468-4" name="rest_code_b6a525c2447f41e99165940d118b5468-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-4"></a>
<a id="rest_code_b6a525c2447f41e99165940d118b5468-5" name="rest_code_b6a525c2447f41e99165940d118b5468-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-5"></a>Info:<span class="w"> </span>Device<span class="w"> </span>utilisation:
<a id="rest_code_b6a525c2447f41e99165940d118b5468-6" name="rest_code_b6a525c2447f41e99165940d118b5468-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-6"></a>Info:<span class="w">            </span>ICESTORM_LC:<span class="w">   </span><span class="m">100</span>/<span class="w"> </span><span class="m">1280</span><span class="w">     </span><span class="m">7</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-7" name="rest_code_b6a525c2447f41e99165940d118b5468-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-7"></a>Info:<span class="w">           </span>ICESTORM_RAM:<span class="w">     </span><span class="m">3</span>/<span class="w">   </span><span class="m">16</span><span class="w">    </span><span class="m">18</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-8" name="rest_code_b6a525c2447f41e99165940d118b5468-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-8"></a>Info:<span class="w">                  </span>SB_IO:<span class="w">    </span><span class="m">28</span>/<span class="w">  </span><span class="m">112</span><span class="w">    </span><span class="m">25</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-9" name="rest_code_b6a525c2447f41e99165940d118b5468-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-9"></a>Info:<span class="w">                  </span>SB_GB:<span class="w">     </span><span class="m">4</span>/<span class="w">    </span><span class="m">8</span><span class="w">    </span><span class="m">50</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-10" name="rest_code_b6a525c2447f41e99165940d118b5468-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-10"></a>Info:<span class="w">           </span>ICESTORM_PLL:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
<a id="rest_code_b6a525c2447f41e99165940d118b5468-11" name="rest_code_b6a525c2447f41e99165940d118b5468-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_b6a525c2447f41e99165940d118b5468-11"></a>Info:<span class="w">            </span>SB_WARMBOOT:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
</pre></div>
<p>Look for the "ICESTORM_RAM" line. We consumed 3 RAM blocks as expected, so the synthesis tool inferred the RAM blocks correctly.</p>
<p>The C part is almost the same as in the previous article, the only difference is that we read few hundres/few thousands of samples from the device and print the data instead of storing it in the binary file:</p>
<div class="code"><pre class="code C"><a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-2"></a><span class="w">    </span><span class="c1">//Reading 500Mb of data from the GPIO</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2500</span><span class="p">;</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">samples_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-5"></a><span class="w">    </span><span class="n">poll_data_from_gpio</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">samples_count</span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-6"></a>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-7"></a><span class="w">    </span><span class="c1">//Calculate the ticks difference between each sample in place</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-9"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-10"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"%02X %02X %02X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-11"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-12"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-13"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">)</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-14"></a><span class="w">        </span><span class="p">);</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-15"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-16"></a>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18" name="rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_ef2fcb9c45df41ce9268d9cf3abb5532-18"></a><span class="p">}</span>
</pre></div>
<p>Compile and test the code:</p>
<div class="code"><pre class="code bash"><a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-1" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-1" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-1"></a>&gt;gcci<span class="w"> </span>-o3<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-o<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.c
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-2" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-2" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-2"></a>&gt;sudo<span class="w"> </span>./test
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-3" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-3" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-3"></a>Done<span class="w"> </span>!!!
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-4" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-4" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-4"></a>FF<span class="w"> </span>FF<span class="w"> </span>1F
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-5" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-5" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-5"></a>FE<span class="w"> </span>FE<span class="w"> </span>1E
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-6" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-6" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-6"></a>FD<span class="w"> </span>FD<span class="w"> </span>1D
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-7" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-7" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-7"></a>FC<span class="w"> </span>FC<span class="w"> </span>1C
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-8" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-8" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-8"></a>FB<span class="w"> </span>FB<span class="w"> </span>1B
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-9" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-9" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-9"></a>FA<span class="w"> </span>FA<span class="w"> </span>1A
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-10" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-10" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-10"></a>F9<span class="w"> </span>F9<span class="w"> </span><span class="m">19</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-11" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-11" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-11"></a>F8<span class="w"> </span>F8<span class="w"> </span><span class="m">18</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-12" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-12" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-12"></a>F7<span class="w"> </span>F7<span class="w"> </span><span class="m">17</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-13" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-13" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-13"></a>F6<span class="w"> </span>F6<span class="w"> </span><span class="m">16</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-14" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-14" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-14"></a>F5<span class="w"> </span>F5<span class="w"> </span><span class="m">15</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-15" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-15" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-15"></a>F4<span class="w"> </span>F4<span class="w"> </span><span class="m">14</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-16" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-16" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-16"></a>F3<span class="w"> </span>F3<span class="w"> </span><span class="m">13</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-17" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-17" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-17"></a>F2<span class="w"> </span>F2<span class="w"> </span><span class="m">12</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-18" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-18" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-18"></a>F1<span class="w"> </span>F1<span class="w"> </span><span class="m">11</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-19" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-19" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-19"></a>F0<span class="w"> </span>F0<span class="w"> </span><span class="m">10</span>
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-20" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-20" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-20"></a>EF<span class="w"> </span>EF<span class="w"> </span>0F
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-21" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-21" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-21"></a>EE<span class="w"> </span>EE<span class="w"> </span>0E
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-22" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-22" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-22"></a>ED<span class="w"> </span>ED<span class="w"> </span>0D
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-23" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-23" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-23"></a>EC<span class="w"> </span>EC<span class="w"> </span>0C
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-24" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-24" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-24"></a>EB<span class="w"> </span>EB<span class="w"> </span>0B
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-25" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-25" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-25"></a>EA<span class="w"> </span>EA<span class="w"> </span>0A
<a id="rest_code_14a8f0765a904c139e6ef8f983eae8c6-26" name="rest_code_14a8f0765a904c139e6ef8f983eae8c6-26" href="posts/streaming-data-from-fpga-using-on-chip-block-ram-as-buffer/#rest_code_14a8f0765a904c139e6ef8f983eae8c6-26"></a>E9<span class="w"> </span>E9<span class="w"> </span><span class="m">09</span>
</pre></div>
<p>The data is read correctly, hooray!</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>We learned how to use RAM in iCE40 FPGA and implemented FIFO buffer. In the next article, we will learn how to read the data from multiple I2S microphones
and push it into the FIFO buffer. Stay tuned!</p>
</section>
</div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/" class="u-url">FPGA-Driven data streaming into Raspberry Pi through GPIO: Speed and timing stability.</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Alex Savochkin
                    </span></p>
            <p class="dateline">
            <a href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/" rel="bookmark">
            <time class="published dt-published" datetime="2024-03-04T17:07:21-08:00" itemprop="datePublished" title="2024-03-04 17:07">2024-03-04 17:07</time></a>
            </p>
                        <p class="commentline">
    


                </p>
</div>
            </header><div class="e-content entry-content">
                    <section id="introduction"><h2>Introduction</h2>
<p>GPIO could be considered one of the options for transferring data at a relatively fast speed
into single-board computers (SBCs), such as the Raspberry Pi. Possible applications include
capturing radio signals for software-defined radio (SDR) or processing data from a microphone
array: each microphone typically captures up to 48K samples per second,
and having a few tens or even hundreds of microphones can result in a significant transfer
rate that needs to be managed.</p>
<p>SBCs, like the Raspberry Pi 4, have substantial computing power and typically
a few gigabytes of RAM, in addition to exposed GPIO pins. The latter makes it easy
to connect them to external devices. Thus, using them as the core of a high-speed data
acquisition and processing system seems attractive.</p>
<p>There are two main approaches for transferring data to/from an SBC via GPIO:
polling (also known as bit-banging) and using DMA. Surprisingly, both can be done in
user space on RPi (although elevated privileges are needed). As shown in
<a class="reference external" href="https://github.com/hzeller/rpi-gpio-dma-demo">https://github.com/hzeller/rpi-gpio-dma-demo</a>, polling is faster, so we will use
polling in our experiments.</p>
<p>In ARM-based systems peripherals, such as UART, SPI, GPIO are typically memory-mapped,
so we can access them by reading and writing to the physical memory addresses corresponding to the
peripheral registers. In order to get access to the memory-mapped GPIO registers, we use mmap to map the
/dev/mem file (which provides physical view of the memory) into the program's address space.</p>
<p>One of the challenges with polling, though, is that SBCs typically run Linux or another general-purpose
operating system, so the CPU is a shared resource, and the system will interrupt our bit-banging process
from time to time, causing the data flow to stop. Consequently, the data stream has to be buffered on the device side.</p>
<p>We will consider a strategy to minimize interruption of the polling process and try see what transfer rate we can acheive
this way. We will also estimate the interruption time and the required buffer size on the device side which will allow not
to loose any data.</p>
</section><section id="reseving-a-cpu-core-for-polling-keeping-the-cpu-frequency-at-maximum"><h2>Reseving a CPU core for polling. Keeping the CPU frequency at maximum</h2>
<p>Turns out that the Linux kernel allows to "set aside" one or a few CPU cores, so the operation system
won't schedule any processes to run on that cores by default. However the system is still aware of
this "reserved" cores and processes can be explicitly assigned to these cores. There are a few
things here we must take into account: first of all, these isolated cores are still interrupted
by the system clock. We expect the interruption time to be no more than a few tenths of microseconds,
but measuring it is one of the goals of this work.</p>
<p>The kernel command line parameter <code>isolcpu &lt;core&gt;</code> allows to "isolate set of CPU from disturbences".
Let's "isolate" 3rd core of RPi4 CPU "form disturbance": here is my kernel command line params file <code>cmdline.txt</code>:</p>
<pre class="literal-block">console=serial0,115200 console=tty1 ...[SKIPPED]... isolcpus=3</pre>
<p>The only change I made was adding <code>isolcpus=3</code> at the end of file.
Now, when you boot into the system you can use a tool like top/htop and confirm that 3rd core is allways idle.
It is possible to explicitly assign a process to that core:</p>
<pre class="literal-block">taskset -c 3 yes &gt; /dev/null &amp;</pre>
<p>Which starts a dummy process <code>yes &gt; /dev/null</code> on 3rd CPU core. Our strategy is to run the polling process on
the isolated core so we will have minimal interruptions from the OS.</p>
<p>Another important consideration is that Raspberry Pi 4 has Dynamic Voltage and Frequency Scaling (DVFS) feature,
so by default the CPU core frequency is lowered when it idles. The frequence scaling policy is controlled by
so-called "governors". The default governor is "ondemand", which tries to keep the CPU frequency as low as possible
when the system is idle and raises it to the maximum value when the system is under load.
In my experiments I found that the task assigned to the isolated core is starting to run slower and
after approximatelly 60 milliseconds the speed gets 2-2.5x faster. If we want to get stable and fast
cycles we need to change the CPU governor to "performance" mode for the core we want to run on. The performance governor
keeps the CPU frequency at the maximum value all the time at the expense of increased power consumption and heat generation.
Here is how we can do it:</p>
<pre class="literal-block">sudo sh -c "echo performance &gt; /sys/devices/system/cpu/cpu3/cpufreq/scaling_governor"</pre>
<p>In this mode the CPU core will run at the maximum frequency all the time.</p>
</section><section id="measuring-setup"><h2>Measuring setup</h2>
<p>To measure transfer rate and timing, we will build a simple timing device based on an FPGA,
which has a fast internal counting timer. The device waits for the rising edge of the
"Data Req" (data request) line and sets its 21-bit data output to the timer's value and the
"Data Rdy" (data ready) line. The polling program detects the change in the "Data Rdy"
line, reads and records the 21-bit data value from the parallel bus, and then sets "Data Req" to low on the SBC.
This signals to the timing device that the SBC has successfully read the data, prompting
it to set "Data Rdy" to low. The polling program detects the falling edge of the "Data Rdy"
line and proceeds to the next cycle iteration. The difference in consecutive data reads from
the timing device allows us to measure the time between loop iterations. We need to measure
two values: the average number of cycles per unit of time (to determine throughput) and
the maximum time between two iterations of the loop (to determine the required buffering size).</p>
<p>The reason we use a 21-bit data bus is that we hit the maximum number pins available on Icestick.
The number of GPIO pins on the Raspberry Pi is 28, and since the protocol uses 3 lines for control,
we have 25 pins remaining on the SBC side.</p>
<p>Here is the wiring diagram of the measuring setup:</p>
<img alt="/images/RPi-Timing-wiring.png" src="images/RPi-Timing-wiring.png" style="width: 773.0px; height: 480.0px;"><p>and its real-life appearance</p>
<img alt="/images/time-measuring-setup.jpg" src="images/time-measuring-setup.jpg" style="width: 320.0px; height: 240.0px;"><p>The exchange process described above can be visualized as follows:</p>
<img alt="/images/RPi-Timing-Sequence.png" src="images/RPi-Timing-Sequence.png" style="width: 675.0px; height: 675.0px;"><p>The polling program (left side of the diagram) is written in C. Here is the source code of the loop:</p>
<div class="code"><pre class="code C"><a id="rest_code_f4c3981c7da54124b7dafa759c867266-1" name="rest_code_f4c3981c7da54124b7dafa759c867266-1" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-2" name="rest_code_f4c3981c7da54124b7dafa759c867266-2" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-2"></a><span class="w">    </span><span class="c1">//Set the DATA_REQUEST signal to the device (25th GPIO pin)</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-3" name="rest_code_f4c3981c7da54124b7dafa759c867266-3" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-3"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">gpio_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_SET_OFFSET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">);</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-4" name="rest_code_f4c3981c7da54124b7dafa759c867266-4" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-4"></a>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-5" name="rest_code_f4c3981c7da54124b7dafa759c867266-5" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-5"></a><span class="w">    </span><span class="c1">//Wait for the DATA_READY signal from the device (27th GPIO pin)</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-6" name="rest_code_f4c3981c7da54124b7dafa759c867266-6" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-6"></a><span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">gpio_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_LEV_OFFSET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-7" name="rest_code_f4c3981c7da54124b7dafa759c867266-7" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-7"></a>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-8" name="rest_code_f4c3981c7da54124b7dafa759c867266-8" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-8"></a><span class="w">    </span><span class="c1">//Read the data from the device, keeping only the lower 24 bits</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-9" name="rest_code_f4c3981c7da54124b7dafa759c867266-9" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-9"></a><span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">gpio_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_LEV_OFFSET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFFFF</span><span class="p">;</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-10" name="rest_code_f4c3981c7da54124b7dafa759c867266-10" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-10"></a>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-11" name="rest_code_f4c3981c7da54124b7dafa759c867266-11" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-11"></a><span class="w">    </span><span class="c1">//Clear the DATA_REQUEST signal to the device</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-12" name="rest_code_f4c3981c7da54124b7dafa759c867266-12" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-12"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">gpio_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_CLR_OFFSET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">);</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-13" name="rest_code_f4c3981c7da54124b7dafa759c867266-13" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-13"></a>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-14" name="rest_code_f4c3981c7da54124b7dafa759c867266-14" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-14"></a><span class="w">    </span><span class="c1">//Wait for the DATA_READY signal from the device to be cleared</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-15" name="rest_code_f4c3981c7da54124b7dafa759c867266-15" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-15"></a><span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">gpio_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_LEV_OFFSET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="rest_code_f4c3981c7da54124b7dafa759c867266-16" name="rest_code_f4c3981c7da54124b7dafa759c867266-16" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_f4c3981c7da54124b7dafa759c867266-16"></a><span class="p">}</span>
</pre></div>
<p>The FPGA code is written in Verilog. Here is some highlights of the timing device design. The icestick has
a 12 MHz reference clock, and we use it with PLL available on the ICE40 FPGA for generatint 50.25 MHz internal
"fast" clock. So our timer resolution is approximatelly 20 ns. Here is how we declare the PLL in verilog:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-1" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-1" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-1"></a><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span><span class="w"> </span><span class="c1">//Declare signal for 50.25MHz clock</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-2" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-2" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-2"></a>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-3" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-3" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-3"></a><span class="n">SB_PLL40_CORE</span><span class="w"> </span><span class="p">#(</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-4" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-4" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-4"></a><span class="w">    </span><span class="p">.</span><span class="n">FEEDBACK_PATH</span><span class="p">(</span><span class="s">"SIMPLE"</span><span class="p">),</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-5" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-5" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-5"></a><span class="w">    </span><span class="p">.</span><span class="n">PLLOUT_SELECT</span><span class="p">(</span><span class="s">"GENCLK"</span><span class="p">),</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-6" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-6" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-6"></a><span class="w">    </span><span class="p">.</span><span class="n">DIVR</span><span class="p">(</span><span class="mh">4</span><span class="mb">'b0000</span><span class="p">),</span><span class="w"> </span><span class="c1">// DIVR = 0  // 12MHz * (DIVF + 1) / (DIVR + 1) = 50.25MHz</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-7" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-7" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-7"></a><span class="w">    </span><span class="p">.</span><span class="n">DIVF</span><span class="p">(</span><span class="mh">7</span><span class="mb">'b1000010</span><span class="p">),</span><span class="w"> </span><span class="c1">// DIVF = 66</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-8" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-8" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-8"></a><span class="w">    </span><span class="p">.</span><span class="n">DIVQ</span><span class="p">(</span><span class="mh">3</span><span class="mb">'b100</span><span class="p">),</span><span class="w"> </span><span class="c1">// DIVQ = 4</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-9" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-9" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-9"></a><span class="w">    </span><span class="p">.</span><span class="n">FILTER_RANGE</span><span class="p">(</span><span class="mh">3</span><span class="mb">'b001</span><span class="p">)</span><span class="w"> </span><span class="c1">// FILTER_RANGE = 1</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-10" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-10" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-10"></a><span class="p">)</span><span class="w"> </span><span class="n">pll</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-11" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-11" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-11"></a><span class="w">    </span><span class="p">.</span><span class="n">REFERENCECLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span><span class="w"> </span><span class="c1">//Input 12MHz ICEStick clock</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-12" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-12" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-12"></a><span class="w">    </span><span class="p">.</span><span class="n">PLLOUTCORE</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w">       </span><span class="c1">//Output 50.25MHz clock</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-13" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-13" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-13"></a><span class="w">    </span><span class="p">.</span><span class="n">LOCK</span><span class="p">(),</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-14" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-14" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-14"></a><span class="w">    </span><span class="p">.</span><span class="n">RESETB</span><span class="p">(</span><span class="mh">1</span><span class="mb">'b1</span><span class="p">),</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-15" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-15" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-15"></a><span class="w">    </span><span class="p">.</span><span class="n">BYPASS</span><span class="p">(</span><span class="mh">1</span><span class="mb">'b0</span><span class="p">)</span>
<a id="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-16" name="rest_code_5e4c7de2c4df484fa4432cb65e7619f3-16" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_5e4c7de2c4df484fa4432cb65e7619f3-16"></a><span class="p">);</span>
</pre></div>
<p>The <code>clk</code> signal is 50.25 MHz clock, provides synchronization. The main logic of the timing device (right part
of the exchagne diagram) can be described by the following verilog code:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-1" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-1" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-1"></a><span class="k">module</span><span class="w"> </span><span class="n">transfer_msr</span><span class="p">(</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-2" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-2" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-2"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">ref_clk</span><span class="p">,</span><span class="w">  </span><span class="c1">//ICEStick 12MHz clock</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-3" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-3" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-4" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-4" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">data_req</span><span class="p">,</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-5" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-5" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-5"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_rdy</span><span class="p">,</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-6" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-6" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">msr_data</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-7" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-7" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-7"></a><span class="p">);</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-8" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-8" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-8"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-9" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-9" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-9"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-10" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-10" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-10"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_2</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-11" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-11" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-11"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-12" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-12" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-12"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">timer_count</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-13" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-13" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-13"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-14" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-14" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-14"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-15" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-15" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-15"></a><span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-16" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-16" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-16"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-17" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-17" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-17"></a><span class="w">    </span><span class="c1">//...[SKIPPED PLL declaration]...</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-18" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-18" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-18"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-19" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-19" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-19"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-20" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-20" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-21" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-21" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-21"></a><span class="w">            </span><span class="n">msr_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-22" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-22" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-22"></a><span class="w">            </span><span class="n">timer_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-23" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-23" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-23"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-24" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-24" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-24"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-25" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-25" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-25"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-26" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-26" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-26"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-27" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-27" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-27"></a><span class="w">            </span><span class="c1">// Since the data_req comes from the external source, we need</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-28" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-28" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-28"></a><span class="w">            </span><span class="c1">// to synchronize it See Harris, Harris, chapters 3.5.5, 4.4.4</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-29" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-29" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-29"></a><span class="w">            </span><span class="c1">// or https://en.wikipedia.org/wiki/Incremental_encoder#Clock_synchronization</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-30" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-30" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">data_req_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-31" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-31" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-31"></a><span class="w">                </span><span class="n">msr_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timer_count</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-32" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-32" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-32"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">data_req_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-33" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-33" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-33"></a><span class="w">                </span><span class="n">data_rdy</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-34" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-34" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-34"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">data_req_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-35" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-35" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-35"></a><span class="w">                </span><span class="n">data_rdy</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-36" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-36" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-36"></a><span class="w">            </span><span class="k">end</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-37" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-37" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-37"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-38" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-38" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">24'hFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-39" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-39" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-39"></a><span class="w">                </span><span class="n">timer_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">'b0</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-40" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-40" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-40"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-41" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-41" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-41"></a><span class="w">                </span><span class="n">timer_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timer_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-42" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-42" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-42"></a><span class="w">            </span><span class="k">end</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-43" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-43" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-43"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-44" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-44" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-44"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-45" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-45" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-45"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-46" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-46" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-46"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-47" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-47" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-47"></a><span class="w">        </span><span class="k">end</span><span class="p">;</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-48" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-48" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-48"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-49" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-49" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-49"></a>
<a id="rest_code_51e8bc8cbc554679a945cb20f8e2a187-50" name="rest_code_51e8bc8cbc554679a945cb20f8e2a187-50" href="posts/fpga-driven-data-streaming-into-raspberry-pi-speed-and-timing-stability-part-1/#rest_code_51e8bc8cbc554679a945cb20f8e2a187-50"></a><span class="k">endmodule</span>
</pre></div>
<p>I use 24-bit counter because I am having I2S INMP441 microphone array as a possible follow-up project.
The resolution of the INMP441 microphone is 24 bits, so I want to have the same resolution for the timer.</p>
</section><section id="results"><h2>Results</h2>
<p>The program reads 500M values of the timer from the FPGA and records and dumps the raw 20 lower bits of the timer to a file.
I post-processed the file to calculate the time between two consecutive reads, so we can see the distribution of the time intervals.</p>
<p>Some observations: the typical timer increment between reads is aroun 19 timer clicks, here is the first 200 reads</p>
<pre class="literal-block">23, 19, 19, 22, 19, 19, 19, 23, 20, 22, 19, 19, 19, 19, 19, 19, 19,
20, 22, 19, 19, 19, 19, 19, 19, 19, 19, 23, 19, 19, 19, 19, 20, 23,
23, 22, 20, 19, 18, 19, 19, 19, 20, 19, 22, 19, 19, 19, 20, 18, 19,
20, 18, 23, 23, 19, 19, 23, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20,
19, 19, 22, 19, 20, 22, 19, 20, 18, 19, 20, 23, 19, 19, 18, 19, 19,
19, 19, 19, 20, 19, 23, 23, 22, 19, 19, 19, 19, 19, 20, 19, 22, 19,
19, 20, 19, 18, 23, 19, 20, 22, 19, 19, 19, 20, 19, 22, 19, 19, 23,
19, 19, 19, 19, 19, 23, 19, 19, 20, 19, 19, 19, 19, 19, 20, 18, 20,
23, 22, 19, 19, 19, 19, 19, 19, 20, 19, 23, 22, 19, 19, 19, 19, 19,
19, 20, 22, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 23,
22, 19, 19, 19, 19, 20, 22, 19, 19, 20, 18, 20, 22, 19, 19, 23, 19,
19, 19, 19, 20, 23, 22, 19, 19, 19, 19, 19, 19</pre>
<p>Since the timer frequency is 50.25MHz, the typical time between reads is 19/50.25MHz = 0.378us, or approximatelly
2.6M reads per second.</p>
<p>Occasionaly we have a few hundreds or even a couple of thousands of timer clicks between reads, which is probably due to the the OS interrupts.</p>
<p>Here is the histogram which illustrates the distribution of pollng cycles timing for 500M cycles:</p>
<img alt="/images/FPGA-timing-hist1.png" src="images/FPGA-timing-hist1.png" style="width: 675.0px; height: 675.0px;"><p>Overwhelming majority of the polling cycles are around 400 ns, but when we zoom out the time axis, we see two more peaks:
around 5500 ns and 9500 ns</p>
<img alt="/images/FPGA-timing-hist2.png" src="images/FPGA-timing-hist2.png" style="width: 675.0px; height: 675.0px;"><p>I think the peaks at 5500 ns and 9500 ns are due to the OS interrupts. Note abrupt end of the histogram at ~18000 ns.</p>
<p>That means if we provide the buffer for storing around 18 micoseconds of the data on the FPGA device side, we can, more or less
handle the stream despite of the occasional polling delays. In microphone array application, for 100 microphones with 24-bit resolution,
at 48KHz sampling rate, we need to store 100*24*48000 = 115.2M bits per second, or 14.4M bytes per second. So, for 18 microseconds delay
we need to provide the buffer of approximatelly 260 bytes, which is more than feasible.</p>
<p>Verilog and C code is available in the <a class="reference external" href="https://github.com/AlexanderSavochkin/RPiGPIOTransferMSR/">github repository</a>.</p>
</section><section id="conclusion-takeaways-future-work-and-follow-ups"><h2>Conclusion, Takeaways, Future Work and Follow-ups</h2>
<ol class="arabic simple">
<li><p>I really loved working with IceStick and APIO/IceStorm tools. It is a great platform for learning and prototyping.
Hovewer, the number of exposed pins is very limited, and we hit the limit here</p></li>
<li><p>Synchronization of the signals coming from outside of device clock domain is super-important. I had frequent glitches
without it:</p></li>
<li><p>Looks like the approach we used here allows us to connect around 50 microphones safely, and we probably need
to push the speed further to connect more microphones. The bottleneck seems to be on the SBC side, I need to
understand if it is possible to squeeze more speed out of the SBC. Another option would be using more powerful
FPGA with big RAM attached to it and moving some of the DSP processing to the FPGA.</p></li>
<li><p>The next step would be to connect a bunch of I2S microphones to the FPGA and transfer real audio data to the SBC.</p></li>
</ol></section>
</div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/unveiling-the-resolver-enigma-using-black-box-method-for-understanding-resolver-and-decoding-shaft-position-part-1/" class="u-url">Unveiling the Resolver Enigma. Using black box method for understanding resolver and decoding shaft position. Part 1</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Alex Savochkin
                    </span></p>
            <p class="dateline">
            <a href="posts/unveiling-the-resolver-enigma-using-black-box-method-for-understanding-resolver-and-decoding-shaft-position-part-1/" rel="bookmark">
            <time class="published dt-published" datetime="2023-12-05T13:27:39-07:00" itemprop="datePublished" title="2023-12-05 13:27">2023-12-05 13:27</time></a>
            </p>
                        <p class="commentline">
    


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>Resolvers are rotary transformers used for measuring
rotation angle of a shaft. Resolvers give analog output in form of
phase shift between sinusoidal signals, so the output signal must
be converted into digital form if we want to use them with digital
control systems.</p>
<p>In most modern applications another type of sensor, encoders, is the usual
"go-to" solution for measuring shaft position and velocity: they are inherently
digital which makes it easy to integrate them in modern control
systems, they have higher accuracy and precision then resolvers
and they can cost fraction of equivalent resolver.</p>
<p>Nevertheless resolvers are still applicable. They can operate
in harsh environments such as extreme temperatures, shock/vibration
and ionizing radiation. Resolvers have been around for
longer time so they can be found in old equipment.</p>
<p>Although resolver-to-digital converter ICs exist, we will rely
on a sound card and a programmatic approach in order to read the shaft
angle from a resolver and will have some fun along the way.
In Part 1, we will use a personal computer sound card along with
a bunch of simple tools for understending the pinout, generating
required exitation signals, reading the output and write the code
which will extract shaft angle from the output  signal using PortAdio,
a popular C library for audio.</p>
<p>To begin I purchased a resolver with the labeling "JQH-11-AGS-4/A386" on eBay.</p>
<img alt="/images/jqh-11-agc4-a386.jpg" src="images/jqh-11-agc4-a386.jpg" style="width: 378.0px; height: 504.0px;"><p>A quick internet search didn't yeild any datasheets or documentation,
so let's try blackbox approach. The labeling on the encoder says:
<strong>ROTOR 2 PHASE 9.75 VOLTS</strong> and <strong>STATOR 2 PHASE 10.1 VOLTS</strong>.
Most probably, we have two windings at <span class="math">\(90^\circ\)</span> on the stator
at and two windings at <span class="math">\(90^\circ\)</span> on the rotor. What we need to do is
to provide reference <span class="math">\(\sin\left(\omega t\right)\)</span> and
<span class="math">\(\cos\left(\omega t\right)\)</span> signals to the stator and read
<span class="math">\(\sin\left(\omega t + \alpha\right)\)</span> and
<span class="math">\(\cos\left(\omega t + \alpha\right)\)</span> output signals from
the rotor, where <span class="math">\(\alpha\)</span> is the shaft rotation angle,
<span class="math">\(\omega = 2\pi f\)</span>, where frequency <span class="math">\(f\)</span> is 400Hz (which
is also labeled on the encoder).</p>
<p>The resolver has two bundles of wires coming out of it. Most probably,
one of the bundles corresponds to rotor windings, and another goes to the stator inside.
What puzzles me, though, is that one of the bundles have 4 wires and another bundle has 8.
The 4-wires bundle has red, black, yellow and blue wires, while the
8-wires bundle has red, yellow, white, blue, green, purple, brown and orange
wires. It turns out that there are color standards for the resolver wires,
although 8-wires bundle colors don't match any color code scheme I could find.</p>
<p>The first thing we can do is to measure resistance between different
pair of wires, so we can find wires corresponding to the individual windings.
It would be interesting to find out which windings are on the rotor and which
are on the stator. In order to check this I decided to bring permanent magnets to
the resolver and spin the shaft. In this case the windings on the rotor will
work as alternator winding and generate alternating voltage on the
wires corresponding to the rotor, while stator's wires shouldn't have any voltage.</p>
<p>I used Dremel tool and two neodym magnets for this test</p>
<div class="vimeo-video">
<iframe src="https://player.vimeo.com/video/832031071" width="640" height="480" frameborder="0" webkitallowfullscreen="webkitAllowFullScreen" mozallowfullscreen="mozallowfullscreen" allowfullscreen="allowFullScreen">
</iframe>
</div>
<p>Here are the results:</p>
<section id="wire-bundle"><h2>4-wire bundle</h2>
<table>
<thead><tr>
<th class="head"><p>Wire Pair</p></th>
<th class="head"><p>Generates voltage when shaft spins</p></th>
<th class="head"><p>Resistance (Ohm)</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>Red-Black</p></td>
<td><p>Yes</p></td>
<td><p>315</p></td>
</tr>
<tr>
<td><p>Yellow-Blue</p></td>
<td><p>Yes</p></td>
<td><p>319</p></td>
</tr>
</tbody>
</table></section><section id="wire-bundle-1"><h2>8-wire bundle</h2>
<table>
<thead><tr>
<th class="head"><p>Wire Pair</p></th>
<th class="head"><p>Generates voltage when shaft spins</p></th>
<th class="head"><p>Resistance (Ohm)</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>Red-Yellow</p></td>
<td><p>No</p></td>
<td><p>313</p></td>
</tr>
<tr>
<td><p>White-Blue</p></td>
<td><p>No</p></td>
<td><p>472</p></td>
</tr>
<tr>
<td><p>Green-Purple</p></td>
<td><p>No</p></td>
<td><p>313</p></td>
</tr>
<tr>
<td><p>Brown-Orange</p></td>
<td><p>No</p></td>
<td><p>471</p></td>
</tr>
</tbody>
</table>
<p>Once we figure out which wire corresponds to which winding we can come up with
a wiring scheme: we will feed the stator winding with two signals having <span class="math">\(90^\circ\)</span>
phase shift between them, so the winding will generate rotating magnetic field inside
the resolver. The rotor winding will generate sinusoidal voltage which will have phase
shift relative to the stator's voltage. The phase shift will correspond to the shaft
angle <span class="math">\(\phi\)</span>.</p>
<p>We will use left and right audio channels of the sound card to generate two
<span class="math">\(90^\circ\)</span> shifted reference signals. We will use two channels of the LINE IN:
one channel will be used to read the reference signal and another channel will be used
to read the output signal from one of the rotating winding. So will use the following wiring scheme:</p>
<img alt="/images/wiring-diagram.png" src="images/wiring-diagram.png" style="width: 675.0px; height: 675.0px;"><p>Having both reference and output signals helps us to compensate for the unkown
phase shift introduced by the sound card circuitry.</p>
<p>Here is video of the test run of the setup:</p>
<div class="youtube-video">
<iframe width="640" height="480" src="https://www.youtube-nocookie.com/embed/gtvyF6dDCQM?rel=0&amp;wmode=transparent" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
</div>
<p>In order to measure the shaft angle we convolve the output signal from rotor
with the reference signals:</p>
<div class="math">
\begin{equation*}
A = \int_{-\frac{\pi}{\omega}}^{\frac{\pi}{\omega}} U_0 \sin(\omega t + \phi) \sin(\omega t ) dx
\end{equation*}
</div>
<div class="math">
\begin{equation*}
B = \int_{-\frac{\pi}{\omega}}^{\frac{\pi}{\omega}} U_0 \sin(\omega t + \phi) \cos(\omega t ) dx
\end{equation*}
</div>
<p>Using</p>
<div class="math">
\begin{equation*}
\sin(\omega t + \phi) = \sin(\omega t) \cos(\phi) + \cos(\omega t) sin(\phi),
\end{equation*}
</div>
<div class="math">
\begin{equation*}
\int_{-\frac{\pi}{\omega}}^{\frac{\pi}{\omega}} U_0 \sin(\omega t) \cos(\omega t ) dx = 0
\end{equation*}
</div>
<p>and</p>
<div class="math">
\begin{equation*}
\int_{-\frac{\pi}{\omega}}^{\frac{\pi}{\omega}} U_0 \sin(\omega t) \sin(\omega t ) dx = \int_{-\frac{\pi}{\omega}}^{\frac{\pi}{\omega}} U_0 \cos(\omega t) \cos(\omega t ) dx = \pi
\end{equation*}
</div>
<p>we can obtain the following relationships between <span class="math">\(A, B\)</span> and <span class="math">\(\phi\)</span>:</p>
<div class="math">
\begin{equation*}
A = \pi U_0 \cos(\phi)
\end{equation*}
</div>
<div class="math">
\begin{equation*}
B = \pi U_0 \sin(\phi)
\end{equation*}
</div>
<div class="math">
\begin{equation*}
\phi = \arctan \frac{B}{A}
\end{equation*}
</div>
<p>Since we are creating a software implementation, we operate in discrete time
domain, so we use the discrete counterparts of the formulas above:</p>
<div class="math">
\begin{equation*}
A = \sum_{n=0}^{N} U_0 \sin(\omega n + \phi) \sin(\omega n )
\end{equation*}
</div>
<div class="math">
\begin{equation*}
B = \sum_{n=0}^{N} U_0 \sin(\omega n + \phi) \cos(\omega n )
\end{equation*}
</div>
<p>This computation is peformed for both reference and output signals, so we get reference
angled <span class="math">\(\phi_{ref}\)</span> and output angle <span class="math">\(\phi_{out}\)</span>. The shaft angle is then <span class="math">\(\phi = \phi_{out} - \phi_{ref}\)</span>.</p>
<p>It is easier if each period corresponds to exact number of samples, so we adjust the frequency slightly: we will
use 400.909Hz instead of 400Hz. This way we will have 110 samples per period at 44100 samples per second.
<span class="math">\(N\)</span> is the number of samples in the signal, must be exact multiple of period.</p>
<p>The source code available on <a class="reference external" href="https://github.com/AlexanderSavochkin/synchroresolver">GitHub:</a>.</p>
<p>Here is the video of the final test run:</p>
<div class="youtube-video">
<iframe width="640" height="480" src="https://www.youtube-nocookie.com/embed/mcpFu2o8uq0?rel=0&amp;wmode=transparent" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
</div></section>
</div>
            </article>
</div>
    

    
    


    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
 MathJax.Hub.Config({
     tex2jax: {
         inlineMath: [ ['$','$'], ["\\(","\\)"] ],
         displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
         processEscapes: true
     },
     displayAlign: 'center', // Change this to 'left' if you want left-aligned equations.
     "HTML-CSS": {
         styles: {'.MathJax_Display': {"margin": 0}}
     }
 });
 </script><!--End of body content--><footer id="footer">
            Contents  2024         <a href="mailto:alexandr.savochkin@gmail.com">Alex Savochkin</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
