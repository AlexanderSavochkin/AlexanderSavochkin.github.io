<section id="introduction">
<h1>Introduction</h1>
<p>This post continues the series of posts describing experiments with using an FPGA as a high-speed
(millions of samples per second) data capturing device. It continues from my previous post, where
we defined the exchange protocol and measured timing. As I concluded in that post, we need to have
a buffer on the capturing device side, which can hold the samples if the computer temporarily stops
polling the data due to handling OS interrupts.</p>
<p>Conveniently, FPGAs typically have RAM on the chip, which can be used for building such a buffer,
and we will explore how to use it in this post. We will create a simple data generator that will
simulate the data and write it into the buffer, and then read the data from the buffer and transfer
it to the parallel bus.</p>
<p>This test program partially implements my project of building a microphone array with multiple INMP441
microphones connected to the FPGA, which I will briefly describe in the next section.</p>
</section>
<section id="high-level-design-overview">
<h1>High level design overview</h1>
<p>Here is the diagram of the digital device I am having in mind</p>
<img alt="/images/microphone-array-simulation.png" src="/images/microphone-array-simulation.png" style="width: 1034.0px; height: 785.0px;" />
<p>According to our estimation, we need a buffer of size &gt; 260 samples. We will implement a 512-sample buffer,
which will have extra space to cover cases when two interrupts come almost simultaneously.</p>
<p>The iCE40HX1K chip has 16 blocks of RAM, each with 4096 bits (512 bytes). Each block can be configured
for storing 256 x 16-bit, 512 x 8-bit bytes, 1024 x 4-bit, or 2048 x 2-bit memory cells. Since I am
aiming to capture 24-bit samples from multiple INMP441 microphones, my samples are 24-bit wide. To
utilize the memory efficiently, I decided to use 3 blocks configured as 512x8: the 1st block will
keep bits 0-7, the 2nd block will keep bits 8-15, and the 3rd block will keep bits 16-23.</p>
<p>We will design the multiple I2S capturing part in the next posts. Today, we will replace it with simulated
data, which will be written into the circular buffer, and focus on data reading and transferring to the parallel bus.</p>
<p>The exchange protocol is the same as in the time measurement setup described in the previous post:
the &quot;device&quot; (FPGA) waits for the rising edge of the &quot;Data Req&quot; (data request) line and sets its
21-bit data output, but this time it reads it from the memory instead of using a timer value.
Then the &quot;device&quot; sets the &quot;Data Rdy&quot; (data ready) line to HIGH. The polling program detects the
change in the &quot;Data Rdy&quot; line, reads and records the 21-bit data value from the parallel bus, and then
sets &quot;Data Req&quot; to low on the SBC. This signals to the device that the SBC has successfully read the data,
prompting it to set &quot;Data Rdy&quot; to low. The polling program detects the falling edge of the &quot;Data Rdy&quot;
line and proceeds to the next cycle iteration.</p>
<p>Previously, we used the timer value as the data. It is pretty much the same in this design, but the timer
value is written to the FIFO buffer, and the reading part of the system gets it from the reading side of
the FIFO and sends it to the parallel bus.</p>
<p>The timer is now 8-bit wide. We repeat it 3 times to get a 24-bit value, so the data should be the least
significant 21 bytes of the 24-bit value {Timer[7:0], Timer[7:0], Timer[7:0]}. As a quick reminder, we are
using a 21-bit data value because we ran out of pins on the iCEstick board.</p>
</section>
<section id="verilog-implementation">
<h1>Verilog implementation</h1>
<p>I think there are modules similar to PLL (see the previous post) which can be used for defining the
RAM block in Verilog.
<a class="reference external" href="https://www.latticesemi.com/-/media/LatticeSemi/Documents/ApplicationNotes/MO/MemoryUsageGuideforiCE40Devices.ashx?document_id=47775">The Memory Usage Guide for iCE40 Devices</a>
mentions the <cite>SB_RAM512x8</cite>, <cite>SB_RAM1024x4</cite> modules, but I think they are Lattice/iCE40-specific and I am not
sure how to use them with apio.</p>
<p>There is also another, more portable way to infer RAM blocks in Verilog, which is supported by most of the FPGA synthesis tools.
We will follow this way in our design. The following code snippet shows how to define a 512x8 memory block in Verilog
which can be inferred as a Block RAM by the synthesis tool.</p>
<div class="code"><pre class="code verilog"><a id="rest_code_767b31156f834fac934fa9045d0691d2-1" name="rest_code_767b31156f834fac934fa9045d0691d2-1" href="#rest_code_767b31156f834fac934fa9045d0691d2-1"></a><span class="k">module</span><span class="w"> </span><span class="n">ram512x8</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-2" name="rest_code_767b31156f834fac934fa9045d0691d2-2" href="#rest_code_767b31156f834fac934fa9045d0691d2-2"></a><span class="p">(</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-3" name="rest_code_767b31156f834fac934fa9045d0691d2-3" href="#rest_code_767b31156f834fac934fa9045d0691d2-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RADDR</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-4" name="rest_code_767b31156f834fac934fa9045d0691d2-4" href="#rest_code_767b31156f834fac934fa9045d0691d2-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RCLK</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-5" name="rest_code_767b31156f834fac934fa9045d0691d2-5" href="#rest_code_767b31156f834fac934fa9045d0691d2-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RE</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-6" name="rest_code_767b31156f834fac934fa9045d0691d2-6" href="#rest_code_767b31156f834fac934fa9045d0691d2-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RDATA</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-7" name="rest_code_767b31156f834fac934fa9045d0691d2-7" href="#rest_code_767b31156f834fac934fa9045d0691d2-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WDATA</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-8" name="rest_code_767b31156f834fac934fa9045d0691d2-8" href="#rest_code_767b31156f834fac934fa9045d0691d2-8"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WADDR</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-9" name="rest_code_767b31156f834fac934fa9045d0691d2-9" href="#rest_code_767b31156f834fac934fa9045d0691d2-9"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WCLK</span><span class="p">,</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-10" name="rest_code_767b31156f834fac934fa9045d0691d2-10" href="#rest_code_767b31156f834fac934fa9045d0691d2-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">WE</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-11" name="rest_code_767b31156f834fac934fa9045d0691d2-11" href="#rest_code_767b31156f834fac934fa9045d0691d2-11"></a><span class="p">);</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-12" name="rest_code_767b31156f834fac934fa9045d0691d2-12" href="#rest_code_767b31156f834fac934fa9045d0691d2-12"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">511</span><span class="p">];</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-13" name="rest_code_767b31156f834fac934fa9045d0691d2-13" href="#rest_code_767b31156f834fac934fa9045d0691d2-13"></a>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-14" name="rest_code_767b31156f834fac934fa9045d0691d2-14" href="#rest_code_767b31156f834fac934fa9045d0691d2-14"></a><span class="w">    </span><span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-15" name="rest_code_767b31156f834fac934fa9045d0691d2-15" href="#rest_code_767b31156f834fac934fa9045d0691d2-15"></a>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-16" name="rest_code_767b31156f834fac934fa9045d0691d2-16" href="#rest_code_767b31156f834fac934fa9045d0691d2-16"></a><span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-17" name="rest_code_767b31156f834fac934fa9045d0691d2-17" href="#rest_code_767b31156f834fac934fa9045d0691d2-17"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">512</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="c1">// start with blank memory with 0 instead of x so that we can infer Yosys for BRAM.</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-18" name="rest_code_767b31156f834fac934fa9045d0691d2-18" href="#rest_code_767b31156f834fac934fa9045d0691d2-18"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-19" name="rest_code_767b31156f834fac934fa9045d0691d2-19" href="#rest_code_767b31156f834fac934fa9045d0691d2-19"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-20" name="rest_code_767b31156f834fac934fa9045d0691d2-20" href="#rest_code_767b31156f834fac934fa9045d0691d2-20"></a>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-21" name="rest_code_767b31156f834fac934fa9045d0691d2-21" href="#rest_code_767b31156f834fac934fa9045d0691d2-21"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">RCLK</span><span class="p">)</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-22" name="rest_code_767b31156f834fac934fa9045d0691d2-22" href="#rest_code_767b31156f834fac934fa9045d0691d2-22"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-23" name="rest_code_767b31156f834fac934fa9045d0691d2-23" href="#rest_code_767b31156f834fac934fa9045d0691d2-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RE</span><span class="p">)</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-24" name="rest_code_767b31156f834fac934fa9045d0691d2-24" href="#rest_code_767b31156f834fac934fa9045d0691d2-24"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-25" name="rest_code_767b31156f834fac934fa9045d0691d2-25" href="#rest_code_767b31156f834fac934fa9045d0691d2-25"></a><span class="w">            </span><span class="n">RDATA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">RADDR</span><span class="p">];</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-26" name="rest_code_767b31156f834fac934fa9045d0691d2-26" href="#rest_code_767b31156f834fac934fa9045d0691d2-26"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-27" name="rest_code_767b31156f834fac934fa9045d0691d2-27" href="#rest_code_767b31156f834fac934fa9045d0691d2-27"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-28" name="rest_code_767b31156f834fac934fa9045d0691d2-28" href="#rest_code_767b31156f834fac934fa9045d0691d2-28"></a>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-29" name="rest_code_767b31156f834fac934fa9045d0691d2-29" href="#rest_code_767b31156f834fac934fa9045d0691d2-29"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">WCLK</span><span class="p">)</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-30" name="rest_code_767b31156f834fac934fa9045d0691d2-30" href="#rest_code_767b31156f834fac934fa9045d0691d2-30"></a><span class="w">    </span><span class="k">begin</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-31" name="rest_code_767b31156f834fac934fa9045d0691d2-31" href="#rest_code_767b31156f834fac934fa9045d0691d2-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WE</span><span class="p">)</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-32" name="rest_code_767b31156f834fac934fa9045d0691d2-32" href="#rest_code_767b31156f834fac934fa9045d0691d2-32"></a><span class="w">        </span><span class="k">begin</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-33" name="rest_code_767b31156f834fac934fa9045d0691d2-33" href="#rest_code_767b31156f834fac934fa9045d0691d2-33"></a><span class="w">            </span><span class="n">memory</span><span class="p">[</span><span class="n">WADDR</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WDATA</span><span class="p">;</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-34" name="rest_code_767b31156f834fac934fa9045d0691d2-34" href="#rest_code_767b31156f834fac934fa9045d0691d2-34"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-35" name="rest_code_767b31156f834fac934fa9045d0691d2-35" href="#rest_code_767b31156f834fac934fa9045d0691d2-35"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_767b31156f834fac934fa9045d0691d2-36" name="rest_code_767b31156f834fac934fa9045d0691d2-36" href="#rest_code_767b31156f834fac934fa9045d0691d2-36"></a><span class="k">endmodule</span>
</pre></div>
<p>When the synthesis tool sees an array of registers with a specific read and write access pattern, which matches the
RAM block (like one above), it will infer the RAM block instead of using the LUTs.</p>
<p>Here is how we define the buffer in our top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-1" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-1" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-1"></a><span class="c1">//Define memory access signals</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-2" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-2" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-2"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-3" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-3" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-3"></a><span class="kt">wire</span><span class="w"> </span><span class="n">r_en</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-4" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-4" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-4"></a><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-5" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-5" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-5"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-6" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-6" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-6"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_data</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-7" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-7" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-7"></a><span class="kt">reg</span><span class="w"> </span><span class="n">w_en</span><span class="p">;</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-8" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-8" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-8"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-9" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-9" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-9"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-10" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-10" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-10"></a><span class="c1">//We will use 3 blocks of 512x8 RAM to store 24-bit samples</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-11" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-11" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-11"></a><span class="c1">//Each the blocks share read address (r_addr), write address (w_addr),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-12" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-12" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-12"></a><span class="c1">//write enable (w_en) and read enable (r_en) signals. We write the same</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-13" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-13" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-13"></a><span class="c1">//value to all 3 blocks, (since it is simulated data), and read the data into</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-14" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-14" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-14"></a><span class="c1">//different bits of the memory_read_value signal.</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-15" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-15" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-15"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-16" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-16" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-16"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_0</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-17" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-17" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-17"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-18" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-18" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-18"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-19" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-19" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-19"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-20" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-20" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-20"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-21" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-21" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-21"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-22" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-22" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-22"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-23" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-23" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-23"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-24" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-24" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-24"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-25" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-25" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-25"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-26" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-26" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-26"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-27" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-27" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-27"></a><span class="p">);</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-28" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-28" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-28"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-29" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-29" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-29"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_1</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-30" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-30" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-30"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">]),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-31" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-31" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-31"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-32" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-32" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-32"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-33" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-33" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-33"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-34" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-34" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-34"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-35" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-35" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-35"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-36" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-36" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-36"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-37" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-37" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-37"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-38" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-38" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-38"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-39" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-39" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-39"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-40" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-40" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-40"></a><span class="p">);</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-41" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-41" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-41"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-42" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-42" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-42"></a><span class="n">ram512x8</span><span class="w"> </span><span class="n">ram512X8_inst_2</span><span class="w"> </span><span class="p">(</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-43" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-43" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-43"></a><span class="w">    </span><span class="p">.</span><span class="n">RDATA</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">]),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-44" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-44" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-44"></a><span class="w">    </span><span class="p">.</span><span class="n">RADDR</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-45" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-45" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-45"></a><span class="w">    </span><span class="p">.</span><span class="n">RCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-46" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-46" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-46"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-47" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-47" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-47"></a><span class="w">    </span><span class="p">.</span><span class="n">RE</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-48" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-48" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-48"></a><span class="w">    </span><span class="p">.</span><span class="n">WADDR</span><span class="p">(</span><span class="n">w_addr</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-49" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-49" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-49"></a><span class="w">    </span><span class="p">.</span><span class="n">WCLK</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-50" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-50" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-50"></a>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-51" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-51" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-51"></a><span class="w">    </span><span class="p">.</span><span class="n">WDATA</span><span class="p">(</span><span class="n">w_data</span><span class="p">),</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-52" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-52" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-52"></a><span class="w">    </span><span class="p">.</span><span class="n">WE</span><span class="p">(</span><span class="n">w_en</span><span class="p">)</span>
<a id="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-53" name="rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-53" href="#rest_code_ef0681e99f144d3bb8fefc0fbd2e0144-53"></a><span class="p">);</span>
</pre></div>
<p>The simulation part is pretty simple, we generate the data and write it into each buffer:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-1" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-1" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-1"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w">  </span><span class="c1">//Controls stage of writing data into the buffer</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-2" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-2" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-2"></a><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter2</span><span class="p">;</span><span class="w"> </span><span class="c1">//Counter representing the simulated data</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-3" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-3" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-3"></a>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-4" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-4" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-4"></a><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">ref_clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-5" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-5" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-6" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-6" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-6"></a><span class="w">        </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-7" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-7" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-7"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-8" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-8" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-8"></a><span class="w">        </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-9" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-9" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-9"></a><span class="w">        </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-10" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-10" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-10"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-11" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-11" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-11"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-12" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-12" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-13" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-13" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-13"></a><span class="w">            </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-14" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-14" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-14"></a><span class="w">            </span><span class="n">w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">~</span><span class="n">counter2</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-15" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-15" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-15"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-16" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-16" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-16"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-17" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-17" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-17"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">5</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-18" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-18" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-18"></a><span class="w">            </span><span class="n">w_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-19" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-19" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-19"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">6</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-20" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-20" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-20"></a><span class="w">            </span><span class="n">counter2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-21" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-21" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-21"></a><span class="w">            </span><span class="n">w_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">w_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-22" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-22" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-22"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-23" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-23" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-23"></a>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-24" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-24" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-24"></a><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-25" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-25" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-25"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-26" name="rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-26" href="#rest_code_7aa6c78b89d1423bbd645ba8f0b2673d-26"></a><span class="k">end</span>
</pre></div>
<p>The average reading speed should be faster then writing speed. If the reader is interrupted for a brief
period of time, the data will be buffered in the RAM. When the reader returns to polling the data, it will catch up
with the writer. If the reader reaches the writer address, it will stop reading the data until the new data arrives.</p>
<p>I implemented the reader in a separate model since want to reuse it in different designs.
Here is the verilog code for the reading part:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_08cb460418784737945d717b3f050f30-1" name="rest_code_08cb460418784737945d717b3f050f30-1" href="#rest_code_08cb460418784737945d717b3f050f30-1"></a><span class="k">module</span><span class="w"> </span><span class="n">parallel_exchange_fsm</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-2" name="rest_code_08cb460418784737945d717b3f050f30-2" href="#rest_code_08cb460418784737945d717b3f050f30-2"></a><span class="p">(</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-3" name="rest_code_08cb460418784737945d717b3f050f30-3" href="#rest_code_08cb460418784737945d717b3f050f30-3"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-4" name="rest_code_08cb460418784737945d717b3f050f30-4" href="#rest_code_08cb460418784737945d717b3f050f30-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-5" name="rest_code_08cb460418784737945d717b3f050f30-5" href="#rest_code_08cb460418784737945d717b3f050f30-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-6" name="rest_code_08cb460418784737945d717b3f050f30-6" href="#rest_code_08cb460418784737945d717b3f050f30-6"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-7" name="rest_code_08cb460418784737945d717b3f050f30-7" href="#rest_code_08cb460418784737945d717b3f050f30-7"></a><span class="w">    </span><span class="c1">//Interraction with memory</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-8" name="rest_code_08cb460418784737945d717b3f050f30-8" href="#rest_code_08cb460418784737945d717b3f050f30-8"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-9" name="rest_code_08cb460418784737945d717b3f050f30-9" href="#rest_code_08cb460418784737945d717b3f050f30-9"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">r_en</span><span class="p">,</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-10" name="rest_code_08cb460418784737945d717b3f050f30-10" href="#rest_code_08cb460418784737945d717b3f050f30-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">,</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-11" name="rest_code_08cb460418784737945d717b3f050f30-11" href="#rest_code_08cb460418784737945d717b3f050f30-11"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-12" name="rest_code_08cb460418784737945d717b3f050f30-12" href="#rest_code_08cb460418784737945d717b3f050f30-12"></a><span class="w">    </span><span class="c1">//Interraction with downstream device</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-13" name="rest_code_08cb460418784737945d717b3f050f30-13" href="#rest_code_08cb460418784737945d717b3f050f30-13"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">data_req</span><span class="p">,</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-14" name="rest_code_08cb460418784737945d717b3f050f30-14" href="#rest_code_08cb460418784737945d717b3f050f30-14"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_out</span><span class="p">,</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-15" name="rest_code_08cb460418784737945d717b3f050f30-15" href="#rest_code_08cb460418784737945d717b3f050f30-15"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_ready</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-16" name="rest_code_08cb460418784737945d717b3f050f30-16" href="#rest_code_08cb460418784737945d717b3f050f30-16"></a><span class="p">);</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-17" name="rest_code_08cb460418784737945d717b3f050f30-17" href="#rest_code_08cb460418784737945d717b3f050f30-17"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-18" name="rest_code_08cb460418784737945d717b3f050f30-18" href="#rest_code_08cb460418784737945d717b3f050f30-18"></a><span class="w">    </span><span class="c1">//Data request synchronization flip-flops</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-19" name="rest_code_08cb460418784737945d717b3f050f30-19" href="#rest_code_08cb460418784737945d717b3f050f30-19"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-20" name="rest_code_08cb460418784737945d717b3f050f30-20" href="#rest_code_08cb460418784737945d717b3f050f30-20"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">data_req_2</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-21" name="rest_code_08cb460418784737945d717b3f050f30-21" href="#rest_code_08cb460418784737945d717b3f050f30-21"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-22" name="rest_code_08cb460418784737945d717b3f050f30-22" href="#rest_code_08cb460418784737945d717b3f050f30-22"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-23" name="rest_code_08cb460418784737945d717b3f050f30-23" href="#rest_code_08cb460418784737945d717b3f050f30-23"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-24" name="rest_code_08cb460418784737945d717b3f050f30-24" href="#rest_code_08cb460418784737945d717b3f050f30-24"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-25" name="rest_code_08cb460418784737945d717b3f050f30-25" href="#rest_code_08cb460418784737945d717b3f050f30-25"></a><span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-26" name="rest_code_08cb460418784737945d717b3f050f30-26" href="#rest_code_08cb460418784737945d717b3f050f30-26"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-27" name="rest_code_08cb460418784737945d717b3f050f30-27" href="#rest_code_08cb460418784737945d717b3f050f30-27"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">paralled_data_io_state</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-28" name="rest_code_08cb460418784737945d717b3f050f30-28" href="#rest_code_08cb460418784737945d717b3f050f30-28"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-29" name="rest_code_08cb460418784737945d717b3f050f30-29" href="#rest_code_08cb460418784737945d717b3f050f30-29"></a><span class="w">    </span><span class="c1">//This FSM handles parallel data output</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-30" name="rest_code_08cb460418784737945d717b3f050f30-30" href="#rest_code_08cb460418784737945d717b3f050f30-30"></a><span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-31" name="rest_code_08cb460418784737945d717b3f050f30-31" href="#rest_code_08cb460418784737945d717b3f050f30-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-32" name="rest_code_08cb460418784737945d717b3f050f30-32" href="#rest_code_08cb460418784737945d717b3f050f30-32"></a><span class="w">            </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">9</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-33" name="rest_code_08cb460418784737945d717b3f050f30-33" href="#rest_code_08cb460418784737945d717b3f050f30-33"></a><span class="w">            </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-34" name="rest_code_08cb460418784737945d717b3f050f30-34" href="#rest_code_08cb460418784737945d717b3f050f30-34"></a><span class="w">            </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-35" name="rest_code_08cb460418784737945d717b3f050f30-35" href="#rest_code_08cb460418784737945d717b3f050f30-35"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-36" name="rest_code_08cb460418784737945d717b3f050f30-36" href="#rest_code_08cb460418784737945d717b3f050f30-36"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-37" name="rest_code_08cb460418784737945d717b3f050f30-37" href="#rest_code_08cb460418784737945d717b3f050f30-37"></a><span class="w">        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-38" name="rest_code_08cb460418784737945d717b3f050f30-38" href="#rest_code_08cb460418784737945d717b3f050f30-38"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-39" name="rest_code_08cb460418784737945d717b3f050f30-39" href="#rest_code_08cb460418784737945d717b3f050f30-39"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-40" name="rest_code_08cb460418784737945d717b3f050f30-40" href="#rest_code_08cb460418784737945d717b3f050f30-40"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">paralled_data_io_state</span><span class="p">)</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-41" name="rest_code_08cb460418784737945d717b3f050f30-41" href="#rest_code_08cb460418784737945d717b3f050f30-41"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_HIGH:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-42" name="rest_code_08cb460418784737945d717b3f050f30-42" href="#rest_code_08cb460418784737945d717b3f050f30-42"></a><span class="w">                    </span><span class="n">r_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w">  </span><span class="c1">//Just keep r_en high all the time for simplicity</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-43" name="rest_code_08cb460418784737945d717b3f050f30-43" href="#rest_code_08cb460418784737945d717b3f050f30-43"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">data_req_2</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-44" name="rest_code_08cb460418784737945d717b3f050f30-44" href="#rest_code_08cb460418784737945d717b3f050f30-44"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_AWAIL</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-45" name="rest_code_08cb460418784737945d717b3f050f30-45" href="#rest_code_08cb460418784737945d717b3f050f30-45"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-46" name="rest_code_08cb460418784737945d717b3f050f30-46" href="#rest_code_08cb460418784737945d717b3f050f30-46"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-47" name="rest_code_08cb460418784737945d717b3f050f30-47" href="#rest_code_08cb460418784737945d717b3f050f30-47"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-48" name="rest_code_08cb460418784737945d717b3f050f30-48" href="#rest_code_08cb460418784737945d717b3f050f30-48"></a><span class="w">                </span><span class="nl">WAITING_DATA_AWAIL:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-49" name="rest_code_08cb460418784737945d717b3f050f30-49" href="#rest_code_08cb460418784737945d717b3f050f30-49"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r_addr</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">//Data available in the buffer</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-50" name="rest_code_08cb460418784737945d717b3f050f30-50" href="#rest_code_08cb460418784737945d717b3f050f30-50"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">READING_BUFFER</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-51" name="rest_code_08cb460418784737945d717b3f050f30-51" href="#rest_code_08cb460418784737945d717b3f050f30-51"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-52" name="rest_code_08cb460418784737945d717b3f050f30-52" href="#rest_code_08cb460418784737945d717b3f050f30-52"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-53" name="rest_code_08cb460418784737945d717b3f050f30-53" href="#rest_code_08cb460418784737945d717b3f050f30-53"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-54" name="rest_code_08cb460418784737945d717b3f050f30-54" href="#rest_code_08cb460418784737945d717b3f050f30-54"></a><span class="w">                </span><span class="nl">READING_BUFFER:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-55" name="rest_code_08cb460418784737945d717b3f050f30-55" href="#rest_code_08cb460418784737945d717b3f050f30-55"></a><span class="w">                    </span><span class="n">r_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">r_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-56" name="rest_code_08cb460418784737945d717b3f050f30-56" href="#rest_code_08cb460418784737945d717b3f050f30-56"></a><span class="w">                    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-57" name="rest_code_08cb460418784737945d717b3f050f30-57" href="#rest_code_08cb460418784737945d717b3f050f30-57"></a><span class="w">                    </span><span class="n">data_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory_read_value</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-58" name="rest_code_08cb460418784737945d717b3f050f30-58" href="#rest_code_08cb460418784737945d717b3f050f30-58"></a><span class="w">                    </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_LOW</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-59" name="rest_code_08cb460418784737945d717b3f050f30-59" href="#rest_code_08cb460418784737945d717b3f050f30-59"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-60" name="rest_code_08cb460418784737945d717b3f050f30-60" href="#rest_code_08cb460418784737945d717b3f050f30-60"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-61" name="rest_code_08cb460418784737945d717b3f050f30-61" href="#rest_code_08cb460418784737945d717b3f050f30-61"></a><span class="w">                </span><span class="nl">WAITING_DATA_REQ_LOW:</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-62" name="rest_code_08cb460418784737945d717b3f050f30-62" href="#rest_code_08cb460418784737945d717b3f050f30-62"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">data_req_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-63" name="rest_code_08cb460418784737945d717b3f050f30-63" href="#rest_code_08cb460418784737945d717b3f050f30-63"></a><span class="w">                        </span><span class="n">paralled_data_io_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">WAITING_DATA_REQ_HIGH</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-64" name="rest_code_08cb460418784737945d717b3f050f30-64" href="#rest_code_08cb460418784737945d717b3f050f30-64"></a><span class="w">                        </span><span class="n">data_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-65" name="rest_code_08cb460418784737945d717b3f050f30-65" href="#rest_code_08cb460418784737945d717b3f050f30-65"></a><span class="w">                    </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-66" name="rest_code_08cb460418784737945d717b3f050f30-66" href="#rest_code_08cb460418784737945d717b3f050f30-66"></a><span class="w">                </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-67" name="rest_code_08cb460418784737945d717b3f050f30-67" href="#rest_code_08cb460418784737945d717b3f050f30-67"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-68" name="rest_code_08cb460418784737945d717b3f050f30-68" href="#rest_code_08cb460418784737945d717b3f050f30-68"></a><span class="w">            </span><span class="k">endcase</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-69" name="rest_code_08cb460418784737945d717b3f050f30-69" href="#rest_code_08cb460418784737945d717b3f050f30-69"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-70" name="rest_code_08cb460418784737945d717b3f050f30-70" href="#rest_code_08cb460418784737945d717b3f050f30-70"></a><span class="w">            </span><span class="n">data_req_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-71" name="rest_code_08cb460418784737945d717b3f050f30-71" href="#rest_code_08cb460418784737945d717b3f050f30-71"></a><span class="w">            </span><span class="n">data_req_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data_req_1</span><span class="p">;</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-72" name="rest_code_08cb460418784737945d717b3f050f30-72" href="#rest_code_08cb460418784737945d717b3f050f30-72"></a><span class="w">        </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-73" name="rest_code_08cb460418784737945d717b3f050f30-73" href="#rest_code_08cb460418784737945d717b3f050f30-73"></a><span class="w">    </span><span class="k">end</span>
<a id="rest_code_08cb460418784737945d717b3f050f30-74" name="rest_code_08cb460418784737945d717b3f050f30-74" href="#rest_code_08cb460418784737945d717b3f050f30-74"></a>
<a id="rest_code_08cb460418784737945d717b3f050f30-75" name="rest_code_08cb460418784737945d717b3f050f30-75" href="#rest_code_08cb460418784737945d717b3f050f30-75"></a><span class="k">endmodule</span>
</pre></div>
<p>Note that if there is no data in the buffer, <code>r_addr == w_addr</code>, the reader will stick in the <code>WAITING_DATA_AWAIL</code> state until the new data arrives.
This is how we use it in the top-level module:</p>
<div class="code"><pre class="code verilog"><a id="rest_code_1bde0b233976410a92c6d51806692b11-1" name="rest_code_1bde0b233976410a92c6d51806692b11-1" href="#rest_code_1bde0b233976410a92c6d51806692b11-1"></a><span class="n">parallel_exchange_fsm</span><span class="w"> </span><span class="n">parallel_exchange_fsm_inst</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-2" name="rest_code_1bde0b233976410a92c6d51806692b11-2" href="#rest_code_1bde0b233976410a92c6d51806692b11-2"></a><span class="p">(</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-3" name="rest_code_1bde0b233976410a92c6d51806692b11-3" href="#rest_code_1bde0b233976410a92c6d51806692b11-3"></a><span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w">                  </span><span class="c1">//Reset</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-4" name="rest_code_1bde0b233976410a92c6d51806692b11-4" href="#rest_code_1bde0b233976410a92c6d51806692b11-4"></a><span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">ref_clk</span><span class="p">),</span><span class="w">                  </span><span class="c1">//12 MHz iCEstick clock</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-5" name="rest_code_1bde0b233976410a92c6d51806692b11-5" href="#rest_code_1bde0b233976410a92c6d51806692b11-5"></a><span class="w">    </span><span class="p">.</span><span class="n">w_addr</span><span class="p">,</span><span class="w">         </span><span class="c1">//Current writing position so we know how much data is available</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-6" name="rest_code_1bde0b233976410a92c6d51806692b11-6" href="#rest_code_1bde0b233976410a92c6d51806692b11-6"></a>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-7" name="rest_code_1bde0b233976410a92c6d51806692b11-7" href="#rest_code_1bde0b233976410a92c6d51806692b11-7"></a><span class="c1">//Interaction with memory</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-8" name="rest_code_1bde0b233976410a92c6d51806692b11-8" href="#rest_code_1bde0b233976410a92c6d51806692b11-8"></a><span class="w">    </span><span class="p">.</span><span class="n">r_addr</span><span class="p">(</span><span class="n">r_addr</span><span class="p">),</span><span class="w">    </span><span class="c1">//Reading address in buffer</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-9" name="rest_code_1bde0b233976410a92c6d51806692b11-9" href="#rest_code_1bde0b233976410a92c6d51806692b11-9"></a><span class="w">    </span><span class="p">.</span><span class="n">r_en</span><span class="p">(</span><span class="n">r_en</span><span class="p">),</span><span class="w">            </span><span class="c1">//Read enable</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-10" name="rest_code_1bde0b233976410a92c6d51806692b11-10" href="#rest_code_1bde0b233976410a92c6d51806692b11-10"></a><span class="w">    </span><span class="p">.</span><span class="n">memory_read_value</span><span class="p">(</span><span class="n">memory_read_value</span><span class="p">),</span><span class="w"> </span><span class="c1">//</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-11" name="rest_code_1bde0b233976410a92c6d51806692b11-11" href="#rest_code_1bde0b233976410a92c6d51806692b11-11"></a>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-12" name="rest_code_1bde0b233976410a92c6d51806692b11-12" href="#rest_code_1bde0b233976410a92c6d51806692b11-12"></a><span class="c1">//Interaction with downstream device</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-13" name="rest_code_1bde0b233976410a92c6d51806692b11-13" href="#rest_code_1bde0b233976410a92c6d51806692b11-13"></a><span class="w">    </span><span class="p">.</span><span class="n">data_req</span><span class="p">(</span><span class="n">data_req</span><span class="p">),</span><span class="w">             </span><span class="c1">//Data request signal</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-14" name="rest_code_1bde0b233976410a92c6d51806692b11-14" href="#rest_code_1bde0b233976410a92c6d51806692b11-14"></a><span class="w">    </span><span class="p">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">data_out</span><span class="p">),</span><span class="w"> </span><span class="c1">//Output data</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-15" name="rest_code_1bde0b233976410a92c6d51806692b11-15" href="#rest_code_1bde0b233976410a92c6d51806692b11-15"></a><span class="w">    </span><span class="p">.</span><span class="n">data_ready</span><span class="p">(</span><span class="n">data_rdy</span><span class="p">)</span><span class="w">       </span><span class="c1">//Data ready signal</span>
<a id="rest_code_1bde0b233976410a92c6d51806692b11-16" name="rest_code_1bde0b233976410a92c6d51806692b11-16" href="#rest_code_1bde0b233976410a92c6d51806692b11-16"></a><span class="p">);</span>
</pre></div>
</section>
<section id="tests-and-results">
<h1>Tests and results</h1>
<p>First of all we need to double check that the synthesis tool could infer the RAM blocks. We can do this by looking at the synthesis report generated by
apio build command in &quot;verbose&quot; mode.</p>
<div class="code"><pre class="code bash"><a id="rest_code_04c13c3620c24beeade374fd40b884d6-1" name="rest_code_04c13c3620c24beeade374fd40b884d6-1" href="#rest_code_04c13c3620c24beeade374fd40b884d6-1"></a>apio<span class="w"> </span>build<span class="w"> </span>--verbose
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-2" name="rest_code_04c13c3620c24beeade374fd40b884d6-2" href="#rest_code_04c13c3620c24beeade374fd40b884d6-2"></a>
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-3" name="rest_code_04c13c3620c24beeade374fd40b884d6-3" href="#rest_code_04c13c3620c24beeade374fd40b884d6-3"></a>....Skipping<span class="w"> </span>some<span class="w"> </span><span class="o">(</span>a<span class="w"> </span>lot<span class="w"> </span>of<span class="o">)</span><span class="w"> </span>output...
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-4" name="rest_code_04c13c3620c24beeade374fd40b884d6-4" href="#rest_code_04c13c3620c24beeade374fd40b884d6-4"></a>
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-5" name="rest_code_04c13c3620c24beeade374fd40b884d6-5" href="#rest_code_04c13c3620c24beeade374fd40b884d6-5"></a>Info:<span class="w"> </span>Device<span class="w"> </span>utilisation:
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-6" name="rest_code_04c13c3620c24beeade374fd40b884d6-6" href="#rest_code_04c13c3620c24beeade374fd40b884d6-6"></a>Info:<span class="w">            </span>ICESTORM_LC:<span class="w">   </span><span class="m">100</span>/<span class="w"> </span><span class="m">1280</span><span class="w">     </span><span class="m">7</span>%
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-7" name="rest_code_04c13c3620c24beeade374fd40b884d6-7" href="#rest_code_04c13c3620c24beeade374fd40b884d6-7"></a>Info:<span class="w">           </span>ICESTORM_RAM:<span class="w">     </span><span class="m">3</span>/<span class="w">   </span><span class="m">16</span><span class="w">    </span><span class="m">18</span>%
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-8" name="rest_code_04c13c3620c24beeade374fd40b884d6-8" href="#rest_code_04c13c3620c24beeade374fd40b884d6-8"></a>Info:<span class="w">                  </span>SB_IO:<span class="w">    </span><span class="m">28</span>/<span class="w">  </span><span class="m">112</span><span class="w">    </span><span class="m">25</span>%
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-9" name="rest_code_04c13c3620c24beeade374fd40b884d6-9" href="#rest_code_04c13c3620c24beeade374fd40b884d6-9"></a>Info:<span class="w">                  </span>SB_GB:<span class="w">     </span><span class="m">4</span>/<span class="w">    </span><span class="m">8</span><span class="w">    </span><span class="m">50</span>%
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-10" name="rest_code_04c13c3620c24beeade374fd40b884d6-10" href="#rest_code_04c13c3620c24beeade374fd40b884d6-10"></a>Info:<span class="w">           </span>ICESTORM_PLL:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
<a id="rest_code_04c13c3620c24beeade374fd40b884d6-11" name="rest_code_04c13c3620c24beeade374fd40b884d6-11" href="#rest_code_04c13c3620c24beeade374fd40b884d6-11"></a>Info:<span class="w">            </span>SB_WARMBOOT:<span class="w">     </span><span class="m">0</span>/<span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
</pre></div>
<p>Look for the &quot;ICESTORM_RAM&quot; line. We consumed 3 RAM blocks as expected, so the synthesis tool inferred the RAM blocks correctly.</p>
<p>The C part is almost the same as in the previous article, the only difference is that we read few hundres/few thousands of samples from the device and print the data instead of storing it in the binary file:</p>
<div class="code"><pre class="code C"><a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-1" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-1" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-2" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-2" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-2"></a><span class="w">    </span><span class="c1">//Reading 500Mb of data from the GPIO</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-3" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-3" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2500</span><span class="p">;</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-4" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-4" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">samples_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-5" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-5" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-5"></a><span class="w">    </span><span class="n">poll_data_from_gpio</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">samples_count</span><span class="p">);</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-6" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-6" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-6"></a>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-7" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-7" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-7"></a><span class="w">    </span><span class="c1">//Calculate the ticks difference between each sample in place</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-8" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-8" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">samples_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-9" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-9" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-9"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-10" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-10" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-10"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-11" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-11" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-11"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-12" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-12" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-12"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-13" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-13" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-13"></a><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">)</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-14" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-14" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-14"></a><span class="w">        </span><span class="p">);</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-15" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-15" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-15"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-16" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-16" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-16"></a>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-17" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-17" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="rest_code_0fa4b87d28f243fdb253a4210b1434e6-18" name="rest_code_0fa4b87d28f243fdb253a4210b1434e6-18" href="#rest_code_0fa4b87d28f243fdb253a4210b1434e6-18"></a><span class="p">}</span>
</pre></div>
<p>Compile and test the code:</p>
<div class="code"><pre class="code bash"><a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-1" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-1" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-1"></a>&gt;gcci<span class="w"> </span>-o3<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-o<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.c
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-2" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-2" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-2"></a>&gt;sudo<span class="w"> </span>./test
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-3" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-3" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-3"></a>Done<span class="w"> </span>!!!
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-4" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-4" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-4"></a>FF<span class="w"> </span>FF<span class="w"> </span>1F
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-5" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-5" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-5"></a>FE<span class="w"> </span>FE<span class="w"> </span>1E
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-6" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-6" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-6"></a>FD<span class="w"> </span>FD<span class="w"> </span>1D
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-7" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-7" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-7"></a>FC<span class="w"> </span>FC<span class="w"> </span>1C
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-8" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-8" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-8"></a>FB<span class="w"> </span>FB<span class="w"> </span>1B
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-9" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-9" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-9"></a>FA<span class="w"> </span>FA<span class="w"> </span>1A
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-10" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-10" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-10"></a>F9<span class="w"> </span>F9<span class="w"> </span><span class="m">19</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-11" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-11" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-11"></a>F8<span class="w"> </span>F8<span class="w"> </span><span class="m">18</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-12" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-12" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-12"></a>F7<span class="w"> </span>F7<span class="w"> </span><span class="m">17</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-13" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-13" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-13"></a>F6<span class="w"> </span>F6<span class="w"> </span><span class="m">16</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-14" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-14" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-14"></a>F5<span class="w"> </span>F5<span class="w"> </span><span class="m">15</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-15" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-15" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-15"></a>F4<span class="w"> </span>F4<span class="w"> </span><span class="m">14</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-16" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-16" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-16"></a>F3<span class="w"> </span>F3<span class="w"> </span><span class="m">13</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-17" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-17" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-17"></a>F2<span class="w"> </span>F2<span class="w"> </span><span class="m">12</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-18" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-18" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-18"></a>F1<span class="w"> </span>F1<span class="w"> </span><span class="m">11</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-19" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-19" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-19"></a>F0<span class="w"> </span>F0<span class="w"> </span><span class="m">10</span>
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-20" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-20" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-20"></a>EF<span class="w"> </span>EF<span class="w"> </span>0F
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-21" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-21" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-21"></a>EE<span class="w"> </span>EE<span class="w"> </span>0E
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-22" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-22" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-22"></a>ED<span class="w"> </span>ED<span class="w"> </span>0D
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-23" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-23" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-23"></a>EC<span class="w"> </span>EC<span class="w"> </span>0C
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-24" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-24" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-24"></a>EB<span class="w"> </span>EB<span class="w"> </span>0B
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-25" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-25" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-25"></a>EA<span class="w"> </span>EA<span class="w"> </span>0A
<a id="rest_code_b7dbed8550ee4bedbf1d00b993921430-26" name="rest_code_b7dbed8550ee4bedbf1d00b993921430-26" href="#rest_code_b7dbed8550ee4bedbf1d00b993921430-26"></a>E9<span class="w"> </span>E9<span class="w"> </span><span class="m">09</span>
</pre></div>
<p>The data is read correctly, hooray!</p>
</section>
<section id="conclusion">
<h1>Conclusion</h1>
<p>We learned how to use RAM in iCE40 FPGA and implemented FIFO buffer. In the next article, we will learn how to read the data from multiple I2S microphones
and push it into the FIFO buffer. Stay tuned!</p>
</section>
<section id="references">
<h1>References</h1>
<ul class="simple">
<li><p>The source code for this article is available at <a class="reference external" href="https://github.com/AlexanderSavochkin/RPiGPIOTBuffering">Github</a></p></li>
<li><p><a class="reference external" href="https://www.latticesemi.com/-/media/LatticeSemi/Documents/ApplicationNotes/MO/MemoryUsageGuideforiCE40Devices.ashx?document_id=47775">The Memory Usage Guide for iCE40 Devices</a></p></li>
</ul>
</section>
